{% extends "base.html" %}

{% block title %}AI –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–¥–∞—á ‚Äî DB Editor{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="bi bi-robot"></i> AI –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–¥–∞—á
                <small class="text-muted fs-6">DeepSeek R1</small>
            </h1>
            <div class="btn-group">
                <button class="btn btn-outline-secondary" onclick="clearChat()">
                    <i class="bi bi-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç
                </button>
                <a href="{{ url_for('view_table', table_name='tasks') }}" class="btn btn-outline-primary">
                    <i class="bi bi-table"></i> –ö —Ç–∞–±–ª–∏—Ü–µ –∑–∞–¥–∞—á
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- –ß–∞—Ç —Å AI -->
    <div class="col-lg-8">
        <div class="card chat-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-chat-dots"></i> –ß–∞—Ç —Å AI</span>
                <span class="badge bg-success" id="statusBadge">–ì–æ—Ç–æ–≤</span>
            </div>
            <div class="card-body chat-body" id="chatBody">
                <div class="chat-welcome text-center text-muted py-5" id="welcomeMessage">
                    <i class="bi bi-lightbulb fs-1 mb-3 d-block"></i>
                    <h5>–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á–∏</h5>
                    <p>–û–ø–∏—à–∏—Ç–µ, –∫–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –≤–∞–º –Ω—É–∂–Ω—ã, –∏ —è –∏—Ö —Å–≥–µ–Ω–µ—Ä–∏—Ä—É—é.</p>
                    <div class="mt-4">
                        <p class="small mb-2">–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:</p>
                        <button class="btn btn-outline-primary btn-sm m-1 quick-prompt"
                                data-prompt="–°–æ–∑–¥–∞–π 3 –∑–∞–¥–∞—á–∏ –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ –Ω–∞ —Ç–µ–º—É –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —É—Ä–∞–≤–Ω–µ–Ω–∏–π, —Å—Ä–µ–¥–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏">
                            üìê –ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
                        </button>
                        <button class="btn btn-outline-primary btn-sm m-1 quick-prompt"
                                data-prompt="–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π 2 —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ –ø–æ —Ñ–∏–∑–∏–∫–µ –Ω–∞ —Ç–µ–º—É –º–µ—Ö–∞–Ω–∏–∫–∏">
                            ‚ö° –§–∏–∑–∏–∫–∞: –º–µ—Ö–∞–Ω–∏–∫–∞
                        </button>
                        <button class="btn btn-outline-primary btn-sm m-1 quick-prompt"
                                data-prompt="–ü—Ä–∏–¥—É–º–∞–π 3 –ø—Ä–æ—Å—Ç—ã–µ –∑–∞–¥–∞—á–∏ –ø–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–µ –ø—Ä–æ —Å–∏—Å—Ç–µ–º—ã —Å—á–∏—Å–ª–µ–Ω–∏—è">
                            üíª –°–∏—Å—Ç–µ–º—ã —Å—á–∏—Å–ª–µ–Ω–∏—è
                        </button>
                        <button class="btn btn-outline-primary btn-sm m-1 quick-prompt"
                                data-prompt="–°–æ–∑–¥–∞–π 2 –∑–∞–¥–∞—á–∏ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –†–æ—Å—Å–∏–∏, —É—Ä–æ–≤–µ–Ω—å easy">
                            üìö –ò—Å—Ç–æ—Ä–∏—è –†–æ—Å—Å–∏–∏
                        </button>
                    </div>
                </div>

                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
                <div id="messagesContainer"></div>
            </div>
            <div class="card-footer">
                <form id="chatForm" class="d-flex gap-2">
                    <input type="text"
                           class="form-control"
                           id="messageInput"
                           placeholder="–û–ø–∏—à–∏—Ç–µ, –∫–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å..."
                           autocomplete="off">
                    <button type="submit" class="btn btn-primary" id="sendBtn">
                        <i class="bi bi-send"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –∑–∞–¥–∞—á -->
    <div class="col-lg-4">
        <div class="card tasks-panel">
            <div class="card-header">
                <i class="bi bi-list-check"></i> –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
                <span class="badge bg-primary ms-2" id="tasksCount">0</span>
            </div>
            <div class="card-body" id="tasksPanel">
                <div class="text-center text-muted py-4" id="noTasksMessage">
                    <i class="bi bi-inbox fs-2 mb-2 d-block"></i>
                    <p class="mb-0">–ó–∞–¥–∞—á–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</p>
                </div>

                <div id="tasksList"></div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="card mt-3">
            <div class="card-header">
                <i class="bi bi-bar-chart"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–∏
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∑–∞–¥–∞—á:</span>
                    <strong id="generatedCount">0</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ë–î:</span>
                    <strong id="addedCount">0</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>–°–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ:</span>
                    <strong id="messagesCount">0</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–¥–∞—á–∏ -->
<div class="modal fade" id="taskPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-eye"></i> –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞—á–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="taskPreviewBody">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ JS -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-success" id="confirmAddTask">
                    <i class="bi bi-plus-lg"></i> –î–æ–±–∞–≤–∏—Ç—å –≤ –ë–î
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// === –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ===
let currentTask = null;
let generatedCount = 0;
let addedCount = 0;
let messagesCount = 0;
let allTasks = [];
let isStreaming = false;

const chatBody = document.getElementById('chatBody');
const messagesContainer = document.getElementById('messagesContainer');
const welcomeMessage = document.getElementById('welcomeMessage');
const tasksList = document.getElementById('tasksList');
const noTasksMessage = document.getElementById('noTasksMessage');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const statusBadge = document.getElementById('statusBadge');

// === –£—Ç–∏–ª–∏—Ç—ã ===

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function updateStats() {
    document.getElementById('generatedCount').textContent = generatedCount;
    document.getElementById('addedCount').textContent = addedCount;
    document.getElementById('messagesCount').textContent = messagesCount;
    document.getElementById('tasksCount').textContent = allTasks.length;
}

function scrollToBottom() {
    chatBody.scrollTop = chatBody.scrollHeight;
}

function setStreaming(streaming) {
    isStreaming = streaming;
    sendBtn.disabled = streaming;
    messageInput.disabled = streaming;

    if (streaming) {
        statusBadge.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
        statusBadge.className = 'badge bg-warning';
        sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    } else {
        statusBadge.textContent = '–ì–æ—Ç–æ–≤';
        statusBadge.className = 'badge bg-success';
        sendBtn.innerHTML = '<i class="bi bi-send"></i>';
    }
}

// === –°–æ–æ–±—â–µ–Ω–∏—è ===

function addMessage(role, content, isStreaming = false) {
    welcomeMessage.style.display = 'none';

    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${role}-message`;

    const icon = role === 'user' ? 'person-fill' : 'robot';
    const label = role === 'user' ? '–í—ã' : 'AI';

    messageDiv.innerHTML = `
        <div class="message-header">
            <i class="bi bi-${icon}"></i> ${label}
        </div>
        <div class="message-content ${isStreaming ? 'streaming' : ''}" id="msg-${Date.now()}">
            ${content}
        </div>
    `;

    messagesContainer.appendChild(messageDiv);
    scrollToBottom();

    if (role !== 'user') {
        messagesCount++;
        updateStats();
    }

    return messageDiv.querySelector('.message-content');
}

function formatMessageContent(text) {
    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ JSON –±–ª–æ–∫–æ–≤
    text = text.replace(/```json\s*([\s\S]*?)\s*```/g, (match, code) => {
        return `<pre class="json-block"><code>${escapeHtml(code)}</code></pre>`;
    });

    // –î—Ä—É–≥–∏–µ code –±–ª–æ–∫–∏
    text = text.replace(/```(\w*)\s*([\s\S]*?)\s*```/g, (match, lang, code) => {
        return `<pre class="code-block"><code>${escapeHtml(code)}</code></pre>`;
    });

    // Inline code
    text = text.replace(/`([^`]+)`/g, '<code>$1</code>');

    // –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
    text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

    // –ü–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
    text = text.replace(/\n/g, '<br>');

    return text;
}

// === –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–¥–∞—á ===

async function parseTasks(text) {
    try {
        const response = await fetch('/api/ai/parse-tasks', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({text: text})
        });

        const data = await response.json();

        if (data.tasks && data.tasks.length > 0) {
            data.tasks.forEach(task => {
                if (!allTasks.some(t => t.question === task.question)) {
                    allTasks.push(task);
                    generatedCount++;
                    addTaskToPanel(task);
                }
            });
            updateStats();
        }
    } catch (e) {
        console.error('Error parsing tasks:', e);
    }
}

function addTaskToPanel(task) {
    noTasksMessage.style.display = 'none';

    const taskIndex = allTasks.indexOf(task);

    const taskCard = document.createElement('div');
    taskCard.className = 'task-card mb-3';
    taskCard.innerHTML = `
        <div class="task-card-header">
            <span class="badge bg-${getDifficultyColor(task.difficulty)}">${task.difficulty}</span>
            <span class="badge bg-secondary">${escapeHtml(task.subject)}</span>
        </div>
        <div class="task-card-body">
            <p class="task-question mb-2">${escapeHtml(task.question).substring(0, 100)}...</p>
            <small class="text-muted">${task.options ? task.options.length : 0} –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞</small>
        </div>
        <div class="task-card-footer">
            <button class="btn btn-sm btn-outline-primary" onclick="previewTask(${taskIndex})">
                <i class="bi bi-eye"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä
            </button>
            <button class="btn btn-sm btn-success" onclick="addTask(${taskIndex})">
                <i class="bi bi-plus"></i> –î–æ–±–∞–≤–∏—Ç—å
            </button>
        </div>
    `;

    tasksList.appendChild(taskCard);
}

function getDifficultyColor(difficulty) {
    switch(difficulty) {
        case 'easy': return 'success';
        case 'medium': return 'warning';
        case 'hard': return 'danger';
        default: return 'secondary';
    }
}

// === –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ ===

function previewTask(index) {
    const task = allTasks[index];
    currentTask = task;

    const previewBody = document.getElementById('taskPreviewBody');
    previewBody.innerHTML = `
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">–ü—Ä–µ–¥–º–µ—Ç</label>
                <input type="text" class="form-control" id="editSubject" value="${escapeHtml(task.subject)}">
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label fw-bold">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                <select class="form-select" id="editDifficulty">
                    <option value="easy" ${task.difficulty === 'easy' ? 'selected' : ''}>Easy</option>
                    <option value="medium" ${task.difficulty === 'medium' ? 'selected' : ''}>Medium</option>
                    <option value="hard" ${task.difficulty === 'hard' ? 'selected' : ''}>Hard</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label fw-bold">–¢–µ–º–∞</label>
                <input type="text" class="form-control" id="editTopic" value="${escapeHtml(task.topic || '')}">
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">–í–æ–ø—Ä–æ—Å</label>
            <textarea class="form-control" id="editQuestion" rows="3">${escapeHtml(task.question)}</textarea>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞</label>
            ${task.options.map((opt, i) => `
                <div class="input-group mb-2">
                    <span class="input-group-text">${i + 1}</span>
                    <input type="text" class="form-control edit-option" value="${escapeHtml(opt)}">
                </div>
            `).join('')}
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</label>
                <input type="text" class="form-control" id="editAnswer" value="${escapeHtml(task.answer)}">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">–ü–æ–¥—Å–∫–∞–∑–∫–∞</label>
                <input type="text" class="form-control" id="editHint" value="${escapeHtml(task.hint || '')}">
            </div>
        </div>
    `;

    const modal = new bootstrap.Modal(document.getElementById('taskPreviewModal'));
    modal.show();
}

async function addTask(index) {
    const task = allTasks[index];

    try {
        const response = await fetch('/api/ai/add-task', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({task: task})
        });

        const data = await response.json();

        if (data.success) {
            addedCount++;
            updateStats();

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
            const taskCards = tasksList.querySelectorAll('.task-card');
            if (taskCards[index]) {
                taskCards[index].classList.add('task-added');
                taskCards[index].querySelector('.btn-success').disabled = true;
                taskCards[index].querySelector('.btn-success').innerHTML = '<i class="bi bi-check"></i> –î–æ–±–∞–≤–ª–µ–Ω–æ';
            }

            showToast('success', `–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞! ID: ${data.task_id}`);
        } else {
            showToast('error', data.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
        }
    } catch (e) {
        showToast('error', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    }
}

document.getElementById('confirmAddTask').addEventListener('click', async function() {
    // –°–æ–±–∏—Ä–∞–µ–º –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    const options = [];
    document.querySelectorAll('.edit-option').forEach(input => {
        options.push(input.value);
    });

    const editedTask = {
        subject: document.getElementById('editSubject').value,
        difficulty: document.getElementById('editDifficulty').value,
        topic: document.getElementById('editTopic').value,
        question: document.getElementById('editQuestion').value,
        options: options,
        answer: document.getElementById('editAnswer').value,
        hint: document.getElementById('editHint').value
    };

    try {
        const response = await fetch('/api/ai/add-task', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({task: editedTask})
        });

        const data = await response.json();

        if (data.success) {
            addedCount++;
            updateStats();
            bootstrap.Modal.getInstance(document.getElementById('taskPreviewModal')).hide();
            showToast('success', `–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞! ID: ${data.task_id}`);
        } else {
            showToast('error', data.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
        }
    } catch (e) {
        showToast('error', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    }
});

// === –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è ===

async function sendMessage(message) {
    if (!message.trim() || isStreaming) return;

    // –î–æ–±–∞–≤–ª—èÔøΩÔøΩ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addMessage('user', escapeHtml(message));
    messagesCount++;
    updateStats();

    messageInput.value = '';
    setStreaming(true);

    // –°–æ–∑–¥–∞—ë–º placeholder –¥–ª—è –æ—Ç–≤–µ—Ç–∞
    const responseContent = addMessage('assistant', '<span class="typing-indicator"><span></span><span></span><span></span></span>', true);

    let fullResponse = '';

    try {
        const response = await fetch('/api/ai/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: message})
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        responseContent.innerHTML = '';

        while (true) {
            const {done, value} = await reader.read();

            if (done) break;

            const text = decoder.decode(value);
            const lines = text.split('\n');

            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));

                        if (data.chunk) {
                            fullResponse += data.chunk;
                            responseContent.innerHTML = formatMessageContent(fullResponse);
                            scrollToBottom();
                        }

                        if (data.done) {
                            // –ü–∞—Ä—Å–∏–º –∑–∞–¥–∞—á–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞
                            await parseTasks(fullResponse);
                        }
                    } catch (e) {
                        // Ignore parse errors
                    }
                }
            }
        }

    } catch (e) {
        responseContent.innerHTML = `<span class="text-danger">–û—à–∏–±–∫–∞: ${escapeHtml(e.message)}</span>`;
    } finally {
        setStreaming(false);
        responseContent.classList.remove('streaming');
    }
}

// === –û—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞ ===

async function clearChat() {
    if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞?')) return;

    try {
        await fetch('/api/ai/clear-history', {method: 'POST'});

        messagesContainer.innerHTML = '';
        welcomeMessage.style.display = 'block';
        tasksList.innerHTML = '';
        noTasksMessage.style.display = 'block';

        allTasks = [];
        generatedCount = 0;
        messagesCount = 0;
        updateStats();

        showToast('success', '–ß–∞—Ç –æ—á–∏—â–µ–Ω');
    } catch (e) {
        showToast('error', '–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏');
    }
}

// === –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ===

function showToast(type, message) {
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        ${escapeHtml(message)}
    `;
    document.body.appendChild(toast);

    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ===

document.getElementById('chatForm').addEventListener('submit', function(e) {
    e.preventDefault();
    sendMessage(messageInput.value);
});

// –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–æ–º–ø—Ç—ã
document.querySelectorAll('.quick-prompt').forEach(btn => {
    btn.addEventListener('click', function() {
        const prompt = this.dataset.prompt;
        messageInput.value = prompt;
        sendMessage(prompt);
    });
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
(async function() {
    try {
        const response = await fetch('/api/ai/get-history');
        const data = await response.json();

        if (data.history && data.history.length > 0) {
            welcomeMessage.style.display = 'none';

            data.history.forEach(msg => {
                const content = formatMessageContent(msg.content);
                addMessage(msg.role, content);

                if (msg.role === 'assistant') {
                    parseTasks(msg.content);
                }
            });
        }
    } catch (e) {
        console.error('Error loading history:', e);
    }
})();
</script>
{% endblock %}