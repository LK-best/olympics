<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduBattle - –û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–µ–¥–∏–Ω–∫–∏</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 16px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px 24px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .input-field {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 14px 18px;
            color: white;
            width: 100%;
            transition: border-color 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .nav-item {
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.25s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(102, 126, 234, 0.25);
        }

        .task-option {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.25s;
        }

        .task-option:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.15);
        }

        .task-option.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.25);
        }

        .task-option.correct {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.2);
        }

        .task-option.wrong {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.2);
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.4s ease;
        }

        .achievement-badge {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .hidden { display: none !important; }

        .fade-in {
            animation: fadeIn 0.35s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse-anim {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .match-result-card {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.25s;
        }

        .match-result-card:hover {
            background: rgba(255,255,255,0.08);
            border-color: #667eea;
        }

        .task-detail-row {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 10px;
        }

        .ws-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .ws-connected { background: #10b981; }
        .ws-disconnected { background: #ef4444; }
        .ws-connecting { background: #f59e0b; animation: pulse 1s infinite; }

        .comparison-bar {
            display: flex;
            height: 24px;
            border-radius: 6px;
            overflow: hidden;
            background: rgba(255,255,255,0.1);
        }

        .comparison-bar .my-part {
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s;
        }

        .comparison-bar .opp-part {
            background: linear-gradient(90deg, #ef4444, #dc2626);
            transition: width 0.3s;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç—É—Ä–Ω–∏—Ä–æ–≤ –∏ –º–∞—Ä–∞—Ñ–æ–Ω–æ–≤ */
        .event-card {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .event-card:hover {
            transform: translateY(-4px);
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }

        .event-card.marathon {
            border-left: 4px solid #f59e0b;
        }

        .event-card.tournament {
            border-left: 4px solid #8b5cf6;
        }

        .event-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .event-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .event-badge.marathon {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.2));
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .event-badge.tournament {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.2));
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .event-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .event-status.active {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .event-status.upcoming {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .event-status.finished {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }

        .event-timer {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .event-timer .time-value {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #f87171, #fbbf24);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .leaderboard-row {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .leaderboard-row:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .leaderboard-row.top-1 {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 193, 7, 0.1));
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .leaderboard-row.top-2 {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.15), rgba(156, 163, 175, 0.1));
            border: 1px solid rgba(192, 192, 192, 0.3);
        }

        .leaderboard-row.top-3 {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.15), rgba(180, 83, 9, 0.1));
            border: 1px solid rgba(205, 127, 50, 0.3);
        }

        .leaderboard-row.my-row {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.4);
        }

        .rank-badge {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            margin-right: 16px;
        }

        .rank-badge.gold {
            background: linear-gradient(135deg, #ffd700, #ffb700);
            color: #1a1a2e;
        }

        .rank-badge.silver {
            background: linear-gradient(135deg, #c0c0c0, #a0a0a0);
            color: #1a1a2e;
        }

        .rank-badge.bronze {
            background: linear-gradient(135deg, #cd7f32, #b45309);
            color: white;
        }

        .rank-badge.default {
            background: rgba(255, 255, 255, 0.1);
            color: #9ca3af;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .activity-icon.training {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2));
        }

        .activity-icon.pvp_win {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
        }

        .activity-icon.pvp_loss {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
        }

        .activity-icon.pvp_draw {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.2));
        }

        .tournament-bracket {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
        }

        .tournament-match {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .tournament-match:hover {
            border-color: rgba(102, 126, 234, 0.4);
        }

        .tournament-match.my-match {
            border-color: rgba(102, 126, 234, 0.5);
            background: rgba(102, 126, 234, 0.1);
        }

        .tournament-match.finished {
            opacity: 0.7;
        }

        .player-slot {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            margin-bottom: 4px;
        }

        .player-slot.winner {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .player-slot.loser {
            opacity: 0.6;
        }

        .prizes-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .prize-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .prize-card.first {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 193, 7, 0.05));
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .prize-card.second {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.1), rgba(156, 163, 175, 0.05));
            border: 1px solid rgba(192, 192, 192, 0.3);
        }

        .prize-card.third {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.1), rgba(180, 83, 9, 0.05));
            border: 1px solid rgba(205, 127, 50, 0.3);
        }

        .prize-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        .tabs-container {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 8px;
        }

        .tab-btn {
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            background: transparent;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .tab-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-btn.active {
            color: white;
            background: rgba(102, 126, 234, 0.2);
            border-bottom: 2px solid #667eea;
        }

        .countdown-timer {
            display: flex;
            gap: 16px;
            justify-content: center;
        }

        .countdown-unit {
            text-align: center;
        }

        .countdown-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .countdown-label {
            font-size: 0.75rem;
            color: #9ca3af;
            text-transform: uppercase;
        }

        .rules-list {
            list-style: none;
            padding: 0;
        }

        .rules-list li {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .rules-list li:last-child {
            border-bottom: none;
        }

        .rule-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(102, 126, 234, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —Å–æ–±—ã—Ç–∏–π */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .shimmer-effect {
            background: linear-gradient(90deg,
                rgba(255,255,255,0) 0%,
                rgba(255,255,255,0.1) 50%,
                rgba(255,255,255,0) 100%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        .glow-effect {
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.3);
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen">
        <!-- —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="loading-screen" class="fixed inset-0 flex items-center justify-center z-50">
            <div class="text-center">
                <div class="text-5xl mb-4">‚öîÔ∏è</div>
                <h1 class="text-3xl font-bold mb-2">EduBattle</h1>
                <p class="text-gray-400 pulse-anim">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </div>

        <!-- —ç–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
        <div id="auth-screen" class="hidden min-h-screen flex items-center justify-center p-4">
            <div class="glass-card p-8 w-full max-w-md fade-in">
                <div class="text-center mb-8">
                    <div class="text-5xl mb-3">‚öîÔ∏è</div>
                    <h1 class="text-3xl font-bold">EduBattle</h1>
                    <p class="text-gray-400 mt-2">–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–µ–¥–∏–Ω–∫–∏</p>
                </div>

                <div id="login-form">
                    <div class="mb-4">
                        <input type="email" id="login-email" class="input-field" placeholder="Email">
                    </div>
                    <div class="mb-6">
                        <input type="password" id="login-password" class="input-field" placeholder="–ü–∞—Ä–æ–ª—å">
                    </div>
                    <button onclick="vypolnitVhod()" class="btn-primary w-full mb-4">–í–æ–π—Ç–∏</button>
                    <p class="text-center text-gray-400">
                        –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?
                        <span onclick="pokazatRegistraciyu()" class="text-purple-400 cursor-pointer hover:underline">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
                    </p>
                </div>

                <div id="register-form" class="hidden">
                    <div class="mb-4">
                        <input type="text" id="reg-name" class="input-field" placeholder="–ò–º—è">
                    </div>
                    <div class="mb-4">
                        <input type="email" id="reg-email" class="input-field" placeholder="Email">
                    </div>
                    <div class="mb-6">
                        <input type="password" id="reg-password" class="input-field" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)">
                    </div>
                    <button onclick="vypolnitRegistraciyu()" class="btn-primary w-full mb-4">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    <p class="text-center text-gray-400">
                        –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?
                        <span onclick="pokazatVhod()" class="text-purple-400 cursor-pointer hover:underline">–í–æ–π—Ç–∏</span>
                    </p>
                </div>

                <div id="auth-error" class="hidden mt-4 p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-300 text-center"></div>
            </div>
        </div>

        <!-- –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
        <div id="main-screen" class="hidden">
            <div class="flex min-h-screen">
                <!-- –±–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
                <aside class="w-64 glass-card m-4 p-4 flex flex-col">
                    <div class="flex items-center gap-3 mb-8 p-3">
                        <div class="text-3xl">‚öîÔ∏è</div>
                        <div>
                            <h2 class="font-bold text-lg">EduBattle</h2>
                            <div class="flex items-center gap-2 text-xs text-gray-400">
                                <span class="ws-status" id="ws-indicator"></span>
                                <span id="ws-status-text">–æ—Ñ–ª–∞–π–Ω</span>
                            </div>
                        </div>
                    </div>

                    <nav class="flex-1 space-y-2">
                        <div class="nav-item active" data-section="dashboard" onclick="pokazatSekciyu('dashboard')">
                            <span>üè†</span> <span>–ì–ª–∞–≤–Ω–∞—è</span>
                        </div>
                        <div class="nav-item" data-section="training" onclick="pokazatSekciyu('training')">
                            <span>üìö</span> <span>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</span>
                        </div>
                        <div class="nav-item" data-section="pvp" onclick="pokazatSekciyu('pvp')">
                            <span>‚öîÔ∏è</span> <span>PvP –ë–æ–π</span>
                        </div>
                        <div class="nav-item" data-section="events" onclick="pokazatSekciyu('events')">
                            <span>üèÜ</span> <span>–¢—É—Ä–Ω–∏—Ä—ã</span>
                        </div>
                        <div class="nav-item" data-section="results" onclick="pokazatSekciyu('results')">
                            <span>üìä</span> <span>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</span>
                        </div>
                        <div class="nav-item" data-section="leaderboard" onclick="pokazatSekciyu('leaderboard')">
                            <span>üéñÔ∏è</span> <span>–†–µ–π—Ç–∏–Ω–≥</span>
                        </div>
                        <div class="nav-item" data-section="profile" onclick="pokazatSekciyu('profile')">
                            <span>üë§</span> <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
                        </div>
                        <div id="admin-nav" class="nav-item hidden" data-section="admin" onclick="pokazatSekciyu('admin')">
                            <span>‚öôÔ∏è</span> <span>–ê–¥–º–∏–Ω–∫–∞</span>
                        </div>
                    </nav>

                    <div class="mt-auto pt-4 border-t border-white/10">
                        <div class="flex items-center gap-3 p-3">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center font-bold" id="user-avatar">U</div>
                            <div class="flex-1 min-w-0">
                                <div class="font-medium truncate" id="user-name-sidebar">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                                <div class="text-xs text-gray-400">–£—Ä–æ–≤–µ–Ω—å <span id="user-level-sidebar">1</span></div>
                            </div>
                        </div>
                        <button onclick="vyjtiIzAkkunta()" class="btn-secondary w-full mt-2 text-sm">–í—ã–π—Ç–∏</button>
                    </div>
                </aside>

                <!-- –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
                <main class="flex-1 p-4 overflow-auto">
                    <!-- —Å–µ–∫—Ü–∏—è –¥–∞—à–±–æ—Ä–¥–∞ -->
                    <section id="section-dashboard" class="fade-in">
                        <h1 class="text-3xl font-bold mb-6">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="welcome-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>!</h1>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                            <div class="stat-card">
                                <div class="text-3xl mb-2">üéØ</div>
                                <div class="text-2xl font-bold" id="stat-solved">0</div>
                                <div class="text-gray-400 text-sm">–†–µ—à–µ–Ω–æ –∑–∞–¥–∞—á</div>
                            </div>
                            <div class="stat-card">
                                <div class="text-3xl mb-2">‚úÖ</div>
                                <div class="text-2xl font-bold" id="stat-correct">0%</div>
                                <div class="text-gray-400 text-sm">–¢–æ—á–Ω–æ—Å—Ç—å</div>
                            </div>
                            <div class="stat-card">
                                <div class="text-3xl mb-2">‚öîÔ∏è</div>
                                <div class="text-2xl font-bold" id="stat-wins">0</div>
                                <div class="text-gray-400 text-sm">–ü–æ–±–µ–¥ –≤ PvP</div>
                            </div>
                            <div class="stat-card">
                                <div class="text-3xl mb-2">üìà</div>
                                <div class="text-2xl font-bold" id="stat-rating">1000</div>
                                <div class="text-gray-400 text-sm">–†–µ–π—Ç–∏–Ω–≥</div>
                            </div>
                        </div>

                        <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ -->
                        <div id="dashboard-events" class="glass-card p-6 mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold">üî• –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è</h3>
                                <button onclick="pokazatSekciyu('events')" class="btn-secondary text-sm">–í—Å–µ —Å–æ–±—ã—Ç–∏—è ‚Üí</button>
                            </div>
                            <div id="dashboard-events-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <p class="text-gray-400 col-span-2 text-center py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="glass-card p-6">
                                <h3 class="text-xl font-bold mb-4">üìä –†–µ—à–µ–Ω–∏—è –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</h3>
                                <div style="height: 250px;">
                                    <canvas id="weekly-chart"></canvas>
                                </div>
                            </div>

                            <div class="glass-card p-6">
                                <h3 class="text-xl font-bold mb-4">üèÖ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
                                <div id="achievements-list" class="grid grid-cols-4 gap-3">
                                </div>
                            </div>
                        </div>

                        <div class="glass-card p-6 mt-6">
                            <h3 class="text-xl font-bold mb-4">üìú –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
                            <div id="activity-list" class="space-y-2 max-h-48 overflow-auto">
                            </div>
                        </div>
                    </section>

                    <!-- —Å–µ–∫—Ü–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ -->
                    <section id="section-training" class="hidden fade-in">
                        <h1 class="text-3xl font-bold mb-6">üìö –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h1>

                        <div id="training-setup" class="glass-card p-6 max-w-2xl">
                            <h3 class="text-xl font-bold mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h3>

                            <div class="mb-4">
                                <label class="block text-gray-400 mb-2">–ü—Ä–µ–¥–º–µ—Ç</label>
                                <select id="training-subject" class="input-field">
                                    <option value="math">–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</option>
                                    <option value="physics">–§–∏–∑–∏–∫–∞</option>
                                    <option value="russian">–†—É—Å—Å–∫–∏–π —è–∑—ã–∫</option>
                                    <option value="history">–ò—Å—Ç–æ—Ä–∏—è</option>
                                    <option value="informatics">–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞</option>
                                </select>
                            </div>

                            <div class="mb-4">
                                <label class="block text-gray-400 mb-2">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                                <select id="training-difficulty" class="input-field">
                                    <option value="adaptive">–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è</option>
                                    <option value="easy">–õ—ë–≥–∫–∞—è</option>
                                    <option value="medium">–°—Ä–µ–¥–Ω—è—è</option>
                                    <option value="hard">–°–ª–æ–∂–Ω–∞—è</option>
                                </select>
                            </div>

                            <div class="mb-6">
                                <label class="block text-gray-400 mb-2">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á</label>
                                <select id="training-count" class="input-field">
                                    <option value="5">5 –∑–∞–¥–∞—á</option>
                                    <option value="10">10 –∑–∞–¥–∞—á</option>
                                    <option value="15">15 –∑–∞–¥–∞—á</option>
                                    <option value="20">20 –∑–∞–¥–∞—á</option>
                                </select>
                            </div>

                            <button onclick="nachatTrenirovku()" class="btn-primary">–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
                        </div>

                        <div id="training-active" class="hidden">
                            <div class="glass-card p-6 mb-4">
                                <div class="flex justify-between items-center mb-4">
                                    <span class="text-gray-400">–ó–∞–¥–∞—á–∞ <span id="training-current">1</span> –∏–∑ <span id="training-total">5</span></span>
                                    <span class="text-xl font-bold" id="training-timer">00:00</span>
                                </div>
                                <div class="progress-bar mb-4">
                                    <div class="progress-fill" id="training-progress" style="width: 0%"></div>
                                </div>
                            </div>

                            <div class="glass-card p-6">
                                <div class="mb-2 text-sm text-purple-400" id="training-topic">–¢–µ–º–∞</div>
                                <h2 class="text-2xl font-bold mb-6" id="training-question">–í–æ–ø—Ä–æ—Å?</h2>

                                <div id="training-options" class="space-y-3 mb-6">
                                </div>

                                <div id="training-hint" class="hidden p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg mb-4">
                                    <span class="text-yellow-400">üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞:</span> <span id="training-hint-text"></span>
                                </div>

                                <div class="flex gap-4">
                                    <button onclick="pokazatPodskazku()" class="btn-secondary">–ü–æ–¥—Å–∫–∞–∑–∫–∞</button>
                                    <button onclick="sleduushayaZadachaTraining()" class="btn-primary" id="training-next-btn" disabled>–î–∞–ª–µ–µ</button>
                                </div>
                            </div>
                        </div>

                        <div id="training-results" class="hidden glass-card p-6 max-w-2xl">
                            <h2 class="text-2xl font-bold mb-4 text-center">üéâ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
                            <div class="grid grid-cols-3 gap-4 mb-6">
                                <div class="stat-card">
                                    <div class="text-3xl font-bold text-green-400" id="result-correct">0</div>
                                    <div class="text-gray-400 text-sm">–ü—Ä–∞–≤–∏–ª—å–Ω–æ</div>
                                </div>
                                <div class="stat-card">
                                    <div class="text-3xl font-bold text-red-400" id="result-wrong">0</div>
                                    <div class="text-gray-400 text-sm">–û—à–∏–±–∫–∏</div>
                                </div>
                                <div class="stat-card">
                                    <div class="text-3xl font-bold text-purple-400" id="result-xp">+0</div>
                                    <div class="text-gray-400 text-sm">XP</div>
                                </div>
                            </div>
                            <button onclick="resetTrenirovku()" class="btn-primary w-full">–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
                        </div>
                    </section>

                    <!-- —Å–µ–∫—Ü–∏—è PvP -->
                    <section id="section-pvp" class="hidden fade-in">
                        <h1 class="text-3xl font-bold mb-6">‚öîÔ∏è PvP –ü–æ–µ–¥–∏–Ω–æ–∫</h1>

                        <div id="pvp-setup" class="glass-card p-6 max-w-2xl">
                            <h3 class="text-xl font-bold mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—è</h3>

                            <div class="mb-4">
                                <label class="block text-gray-400 mb-2">–ü—Ä–µ–¥–º–µ—Ç</label>
                                <select id="pvp-subject" class="input-field">
                                    <option value="math">–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</option>
                                    <option value="physics">–§–∏–∑–∏–∫–∞</option>
                                    <option value="russian">–†—É—Å—Å–∫–∏–π —è–∑—ã–∫</option>
                                    <option value="history">–ò—Å—Ç–æ—Ä–∏—è</option>
                                    <option value="informatics">–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞</option>
                                </select>
                            </div>

                            <div class="mb-6">
                                <label class="block text-gray-400 mb-2">–†–µ–∂–∏–º</label>
                                <select id="pvp-mode" class="input-field">
                                    <option value="ranked">–†–µ–π—Ç–∏–Ω–≥–æ–≤—ã–π</option>
                                    <option value="casual">–û–±—ã—á–Ω—ã–π</option>
                                </select>
                            </div>

                            <div class="flex gap-4">
                                <button onclick="iskatSopernika()" class="btn-primary flex-1">–ù–∞–π—Ç–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞</button>
                                <button onclick="igratSBotom()" class="btn-secondary flex-1">–ò–≥—Ä–∞—Ç—å —Å –±–æ—Ç–æ–º</button>
                            </div>
                        </div>

                        <div id="pvp-searching" class="hidden glass-card p-6 max-w-2xl text-center">
                            <div class="text-5xl mb-4 pulse-anim">üîç</div>
                            <h2 class="text-2xl font-bold mb-2">–ü–æ–∏—Å–∫ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...</h2>
                            <p class="text-gray-400 mb-4">–ü–æ–∑–∏—Ü–∏—è –≤ –æ—á–µ—Ä–µ–¥–∏: <span id="queue-position">1</span></p>
                            <button onclick="otmenitPoisk()" class="btn-secondary">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                            <button onclick="igratSBotom()" class="btn-secondary ml-2">–ò–≥—Ä–∞—Ç—å —Å –±–æ—Ç–æ–º</button>
                        </div>

                        <div id="pvp-match" class="hidden">
                            <div class="glass-card p-4 mb-4">
                                <div class="flex justify-between items-center">
                                    <div class="text-center">
                                        <div class="font-bold" id="pvp-my-name">–í—ã</div>
                                        <div class="text-3xl font-bold text-green-400" id="pvp-my-score">0</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-gray-400 text-sm">–ó–∞–¥–∞—á–∞ <span id="pvp-task-num">1</span>/5</div>
                                        <div class="text-2xl font-bold" id="pvp-timer">30</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="font-bold" id="pvp-opp-name">–°–æ–ø–µ—Ä–Ω–∏–∫</div>
                                        <div class="text-3xl font-bold text-red-400" id="pvp-opp-score">0</div>
                                    </div>
                                </div>
                            </div>

                            <div class="glass-card p-6">
                                <div class="mb-2 text-sm text-purple-400" id="pvp-topic">–¢–µ–º–∞</div>
                                <h2 class="text-2xl font-bold mb-6" id="pvp-question">–í–æ–ø—Ä–æ—Å?</h2>

                                <div id="pvp-options" class="space-y-3 mb-6">
                                </div>

                                <button onclick="sleduushayaZadachaPvP()" class="btn-primary w-full" id="pvp-next-btn" disabled>–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å</button>
                            </div>
                        </div>

                        <div id="pvp-result" class="hidden glass-card p-6 max-w-2xl text-center">
                            <div class="text-6xl mb-4" id="pvp-result-emoji">üèÜ</div>
                            <h2 class="text-3xl font-bold mb-2" id="pvp-result-title">–ü–æ–±–µ–¥–∞!</h2>
                            <p class="text-xl text-gray-400 mb-4" id="pvp-result-score">5 : 3</p>
                            <p class="text-lg mb-6" id="pvp-rating-change">–†–µ–π—Ç–∏–Ω–≥: +25</p>
                            <div class="flex gap-4 justify-center">
                                <button onclick="pokazatDetaliBoya()" class="btn-secondary">–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</button>
                                <button onclick="resetPvP()" class="btn-primary">–ù–æ–≤—ã–π –±–æ–π</button>
                            </div>
                        </div>
                    </section>

                    <!-- —Å–µ–∫—Ü–∏—è —Ç—É—Ä–Ω–∏—Ä–æ–≤ –∏ –º–∞—Ä–∞—Ñ–æ–Ω–æ–≤ -->
                    <section id="section-events" class="hidden fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold">üèÜ –¢—É—Ä–Ω–∏—Ä—ã –∏ –ú–∞—Ä–∞—Ñ–æ–Ω—ã</h1>
                            <div id="admin-event-btn" class="hidden">
                                <button onclick="pokazatFormuSozdaniyaEventa()" class="btn-primary">+ –°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
                            </div>
                        </div>

                        <!-- –°–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π -->
                        <div id="events-list-view">
                            <!-- –¢–∞–±—ã -->
                            <div class="tabs-container">
                                <button class="tab-btn active" onclick="filterEventy('all', this)">–í—Å–µ</button>
                                <button class="tab-btn" onclick="filterEventy('active', this)">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
                                <button class="tab-btn" onclick="filterEventy('upcoming', this)">–°–∫–æ—Ä–æ</button>
                                <button class="tab-btn" onclick="filterEventy('marathon', this)">–ú–∞—Ä–∞—Ñ–æ–Ω—ã</button>
                                <button class="tab-btn" onclick="filterEventy('tournament', this)">–¢—É—Ä–Ω–∏—Ä—ã</button>
                                <button class="tab-btn" onclick="filterEventy('my', this)">–ú–æ–∏</button>
                            </div>

                            <!-- –ú–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è -->
                            <div id="my-active-events" class="mb-8">
                                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                                    <span>‚≠ê</span> –ú–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
                                </h3>
                                <div id="my-active-events-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <p class="text-gray-400 col-span-2 text-center py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                                </div>
                            </div>

                            <!-- –í—Å–µ —Å–æ–±—ã—Ç–∏—è -->
                            <div>
                                <h3 class="text-xl font-bold mb-4">üìÖ –í—Å–µ —Å–æ–±—ã—Ç–∏—è</h3>
                                <div id="all-events-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <p class="text-gray-400 col-span-3 text-center py-8">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</p>
                                </div>
                            </div>
                        </div>

                        <!-- –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–±—ã—Ç–∏—è -->
                        <div id="event-detail-view" class="hidden">
                            <button onclick="vernutsyaKSpiskuEventov()" class="btn-secondary mb-4">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</button>

                            <!-- –®–∞–ø–∫–∞ —Å–æ–±—ã—Ç–∏—è -->
                            <div class="glass-card p-6 mb-6">
                                <div class="flex flex-wrap justify-between items-start gap-4">
                                    <div>
                                        <div class="flex items-center gap-3 mb-2">
                                            <span class="event-badge" id="event-detail-badge">–¢—É—Ä–Ω–∏—Ä</span>
                                            <span class="event-status" id="event-detail-status">–ê–∫—Ç–∏–≤–µ–Ω</span>
                                        </div>
                                        <h2 class="text-3xl font-bold mb-2" id="event-detail-name">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h2>
                                        <p class="text-gray-400" id="event-detail-description">–û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</p>
                                    </div>
                                    <div id="event-join-section" class="text-right">
                                        <div class="text-sm text-gray-400 mb-2">
                                            <span id="event-detail-participants">0</span> / <span id="event-detail-max">100</span> —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                                        </div>
                                        <button id="event-join-btn" onclick="prisoedinitsyaKEventu()" class="btn-success">
                                            –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å
                                        </button>
                                    </div>
                                </div>

                                <!-- –¢–∞–π–º–µ—Ä -->
                                <div id="event-timer-section" class="mt-6 event-timer">
                                    <div class="text-sm text-gray-400 mb-2" id="event-timer-label">–î–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</div>
                                    <div class="countdown-timer" id="event-countdown">
                                        <div class="countdown-unit">
                                            <div class="countdown-value" id="countdown-days">00</div>
                                            <div class="countdown-label">–¥–Ω–µ–π</div>
                                        </div>
                                        <div class="countdown-unit">
                                            <div class="countdown-value" id="countdown-hours">00</div>
                                            <div class="countdown-label">—á–∞—Å–æ–≤</div>
                                        </div>
                                        <div class="countdown-unit">
                                            <div class="countdown-value" id="countdown-minutes">00</div>
                                            <div class="countdown-label">–º–∏–Ω—É—Ç</div>
                                        </div>
                                        <div class="countdown-unit">
                                            <div class="countdown-value" id="countdown-seconds">00</div>
                                            <div class="countdown-label">—Å–µ–∫—É–Ω–¥</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                                <div id="my-event-stats" class="hidden mt-6 p-4 bg-purple-500/10 border border-purple-500/30 rounded-lg">
                                    <h4 class="font-bold mb-3">üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
                                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                        <div class="text-center">
                                            <div class="text-2xl font-bold text-yellow-400" id="my-event-rank">#-</div>
                                            <div class="text-xs text-gray-400">–ú–µ—Å—Ç–æ</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-2xl font-bold text-purple-400" id="my-event-score">0</div>
                                            <div class="text-xs text-gray-400">–û—á–∫–∏</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-2xl font-bold" id="my-event-tasks">0</div>
                                            <div class="text-xs text-gray-400">–ó–∞–¥–∞—á</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-2xl font-bold" id="my-event-matches">0</div>
                                            <div class="text-xs text-gray-400">–ú–∞—Ç—á–µ–π</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-2xl font-bold text-green-400" id="my-event-wins">0</div>
                                            <div class="text-xs text-gray-400">–ü–æ–±–µ–¥</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- –¢–∞–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å–æ–±—ã—Ç–∏—è -->
                            <div class="tabs-container">
                                <button class="tab-btn active" onclick="pokazatEventTab('leaderboard', this)">üèÖ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</button>
                                <button class="tab-btn" onclick="pokazatEventTab('rules', this)">üìã –ü—Ä–∞–≤–∏–ª–∞</button>
                                <button class="tab-btn" onclick="pokazatEventTab('prizes', this)">üéÅ –ü—Ä–∏–∑—ã</button>
                                <button class="tab-btn" id="tab-activity" onclick="pokazatEventTab('activity', this)">üìà –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</button>
                                <button class="tab-btn" id="tab-matches" onclick="pokazatEventTab('matches', this)">‚öîÔ∏è –ú–∞—Ç—á–∏</button>
                            </div>

                            <!-- –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ -->
                            <div id="event-tab-leaderboard" class="glass-card p-6">
                                <h3 class="text-xl font-bold mb-4">üèÖ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h3>
                                <div id="event-leaderboard-list">
                                    <p class="text-gray-400 text-center py-8">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                                </div>
                            </div>

                            <!-- –ü—Ä–∞–≤–∏–ª–∞ -->
                            <div id="event-tab-rules" class="hidden glass-card p-6">
                                <h3 class="text-xl font-bold mb-4">üìã –ü—Ä–∞–≤–∏–ª–∞</h3>
                                <div id="event-rules-content">
                                </div>
                            </div>

                            <!-- –ü—Ä–∏–∑—ã -->
                            <div id="event-tab-prizes" class="hidden glass-card p-6">
                                <h3 class="text-xl font-bold mb-4">üéÅ –ü—Ä–∏–∑—ã</h3>
                                <div id="event-prizes-content" class="prizes-container">
                                </div>
                            </div>

                            <!-- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–¥–ª—è –º–∞—Ä–∞—Ñ–æ–Ω–æ–≤) -->
                            <div id="event-tab-activity" class="hidden glass-card p-6">
                                <h3 class="text-xl font-bold mb-4">üìà –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
                                <div id="event-activity-list">
                                    <p class="text-gray-400 text-center py-8">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                                </div>
                            </div>

                            <!-- –ú–∞—Ç—á–∏ (–¥–ª—è —Ç—É—Ä–Ω–∏—Ä–æ–≤) -->
                            <div id="event-tab-matches" class="hidden glass-card p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-bold">‚öîÔ∏è –ú–∞—Ç—á–∏ —Ç—É—Ä–Ω–∏—Ä–∞</h3>
                                    <div class="flex items-center gap-4">
                                        <span class="text-gray-400">–†–∞—É–Ω–¥: <span id="tournament-current-round">1</span> / <span id="tournament-total-rounds">5</span></span>
                                        <button id="start-round-btn" onclick="nachatRaundTurnira()" class="btn-primary hidden">–ù–∞—á–∞—Ç—å —Ä–∞—É–Ω–¥</button>
                                    </div>
                                </div>
                                <div id="tournament-matches-list">
                                    <p class="text-gray-400 text-center py-8">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                                </div>
                            </div>
                        </div>

                        <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤) -->
                        <div id="event-create-form" class="hidden glass-card p-6 max-w-2xl">
                            <h3 class="text-xl font-bold mb-4">–°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</h3>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-400 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                    <input type="text" id="event-create-name" class="input-field" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è">
                                </div>

                                <div>
                                    <label class="block text-gray-400 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                                    <textarea id="event-create-description" class="input-field" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è"></textarea>
                                </div>

                                <div>
                                    <label class="block text-gray-400 mb-2">–¢–∏–ø</label>
                                    <select id="event-create-type" class="input-field">
                                        <option value="marathon">–ú–∞—Ä–∞—Ñ–æ–Ω</option>
                                        <option value="tournament">–¢—É—Ä–Ω–∏—Ä</option>
                                    </select>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-gray-400 mb-2">–ù–∞—á–∞–ª–æ</label>
                                        <input type="datetime-local" id="event-create-start" class="input-field">
                                    </div>
                                    <div>
                                        <label class="block text-gray-400 mb-2">–û–∫–æ–Ω—á–∞–Ω–∏–µ</label>
                                        <input type="datetime-local" id="event-create-end" class="input-field">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-gray-400 mb-2">–ú–∞–∫—Å. —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</label>
                                    <input type="number" id="event-create-max" class="input-field" value="100">
                                </div>

                                <div>
                                    <label class="block text-gray-400 mb-2">–ü—Ä–µ–¥–º–µ—Ç—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                                    <input type="text" id="event-create-subjects" class="input-field" placeholder="math, physics –∏–ª–∏ all">
                                </div>

                                <div class="flex gap-4">
                                    <button onclick="sozdatEvent()" class="btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                                    <button onclick="otmenitSozdanieEventa()" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- —Å–µ–∫—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
                    <section id="section-results" class="hidden fade-in">
                        <h1 class="text-3xl font-bold mb-6">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–æ—ë–≤</h1>

                        <div id="results-list-view">
                            <div class="glass-card p-6 mb-6">
                                <h3 class="text-xl font-bold mb-4">–ò—Å—Ç–æ—Ä–∏—è –º–∞—Ç—á–µ–π</h3>
                                <div id="matches-history-list" class="space-y-3">
                                    <p class="text-gray-400 text-center py-8">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</p>
                                </div>
                            </div>
                        </div>

                        <div id="results-detail-view" class="hidden">
                            <button onclick="vernutsyaKSpiskuMatchey()" class="btn-secondary mb-4">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</button>

                            <div class="glass-card p-6 mb-6">
                                <div class="flex justify-between items-center mb-6">
                                    <div class="text-center">
                                        <div class="text-gray-400 text-sm">–í—ã</div>
                                        <div class="text-3xl font-bold text-green-400" id="detail-my-score">0</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-5xl" id="detail-result-emoji">‚öîÔ∏è</div>
                                        <div class="font-bold mt-2" id="detail-result-text">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-gray-400 text-sm" id="detail-opp-name">–°–æ–ø–µ—Ä–Ω–∏–∫</div>
                                        <div class="text-3xl font-bold text-red-400" id="detail-opp-score">0</div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                    <div class="stat-card">
                                        <div class="text-sm text-gray-400">–ü—Ä–µ–¥–º–µ—Ç</div>
                                        <div class="font-bold" id="detail-subject">-</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="text-sm text-gray-400">–†–µ–∂–∏–º</div>
                                        <div class="font-bold" id="detail-mode">-</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="text-sm text-gray-400">–í–∞—à–µ —Å—Ä. –≤—Ä–µ–º—è</div>
                                        <div class="font-bold" id="detail-avg-time">-</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="text-sm text-gray-400">–†–µ–π—Ç–∏–Ω–≥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞</div>
                                        <div class="font-bold" id="detail-opp-rating">-</div>
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-green-400">–í—ã</span>
                                        <span class="text-red-400">–°–æ–ø–µ—Ä–Ω–∏–∫</span>
                                    </div>
                                    <div class="comparison-bar">
                                        <div class="my-part" id="detail-comparison-my" style="width: 50%"></div>
                                        <div class="opp-part" id="detail-comparison-opp" style="width: 50%"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="glass-card p-6">
                                <h3 class="text-xl font-bold mb-4">–î–µ—Ç–∞–ª–∏ –ø–æ –∑–∞–¥–∞–Ω–∏—è–º</h3>
                                <div id="tasks-details-list" class="space-y-4">
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- —Å–µ–∫—Ü–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞ -->
                    <section id="section-leaderboard" class="hidden fade-in">
                        <h1 class="text-3xl font-bold mb-6">üéñÔ∏è –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h1>

                        <div class="glass-card p-6">
                            <div id="leaderboard-list" class="space-y-2">
                            </div>
                        </div>
                    </section>

                    <!-- —Å–µ–∫—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è -->
                    <section id="section-profile" class="hidden fade-in">
                        <h1 class="text-3xl font-bold mb-6">üë§ –ü—Ä–æ—Ñ–∏–ª—å</h1>

                        <div class="glass-card p-6 max-w-2xl mb-6">
                            <div class="flex items-center gap-6 mb-6">
                                <div class="w-20 h-20 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-3xl font-bold" id="profile-avatar">U</div>
                                <div>
                                    <h2 class="text-2xl font-bold" id="profile-name">–ò–º—è</h2>
                                    <p class="text-gray-400" id="profile-email">email@example.com</p>
                                </div>
                            </div>

                            <div class="mb-4">
                                <div class="flex justify-between mb-1">
                                    <span>–£—Ä–æ–≤–µ–Ω—å <span id="profile-level">1</span></span>
                                    <span><span id="profile-xp">0</span> XP</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="profile-xp-bar" style="width: 0%"></div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="stat-card">
                                    <div class="text-2xl font-bold" id="profile-rating">1000</div>
                                    <div class="text-gray-400 text-sm">–†–µ–π—Ç–∏–Ω–≥</div>
                                </div>
                                <div class="stat-card">
                                    <div class="text-2xl font-bold" id="profile-winrate">0%</div>
                                    <div class="text-gray-400 text-sm">–í–∏–Ω—Ä–µ–π—Ç</div>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card p-6 max-w-2xl">
                            <h3 class="text-xl font-bold mb-4">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º</h3>
                            <div id="subject-stats" class="space-y-3">
                            </div>
                        </div>
                    </section>

                    <!-- —Å–µ–∫—Ü–∏—è –∞–¥–º–∏–Ω–∫–∏ -->
                    <section id="section-admin" class="hidden fade-in">
                        <h1 class="text-3xl font-bold mb-6">‚öôÔ∏è –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="glass-card p-6">
                                <h3 class="text-xl font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</h3>
                                <div class="space-y-4">
                                    <select id="admin-subject" class="input-field">
                                        <option value="math">–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</option>
                                        <option value="physics">–§–∏–∑–∏–∫–∞</option>
                                        <option value="russian">–†—É—Å—Å–∫–∏–π —è–∑—ã–∫</option>
                                        <option value="history">–ò—Å—Ç–æ—Ä–∏—è</option>
                                        <option value="informatics">–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞</option>
                                    </select>
                                    <select id="admin-difficulty" class="input-field">
                                        <option value="easy">–õ—ë–≥–∫–∞—è</option>
                                        <option value="medium">–°—Ä–µ–¥–Ω—è—è</option>
                                        <option value="hard">–°–ª–æ–∂–Ω–∞—è</option>
                                    </select>
                                    <input type="text" id="admin-topic" class="input-field" placeholder="–¢–µ–º–∞">
                                    <textarea id="admin-question" class="input-field" placeholder="–í–æ–ø—Ä–æ—Å" rows="2"></textarea>
                                    <input type="text" id="admin-options" class="input-field" placeholder="–í–∞—Ä–∏–∞–Ω—Ç—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é">
                                    <input type="text" id="admin-answer" class="input-field" placeholder="–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç">
                                    <input type="text" id="admin-hint" class="input-field" placeholder="–ü–æ–¥—Å–∫–∞–∑–∫–∞">
                                    <button onclick="dobavitZadachu()" class="btn-primary w-full">–î–æ–±–∞–≤–∏—Ç—å</button>
                                </div>
                            </div>

                            <div class="glass-card p-6">
                                <h3 class="text-xl font-bold mb-4">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–¥–∞—á</h3>
                                <div class="space-y-4">
                                    <select id="gen-subject" class="input-field">
                                        <option value="math">–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</option>
                                    </select>
                                    <select id="gen-difficulty" class="input-field">
                                        <option value="easy">–õ—ë–≥–∫–∞—è</option>
                                        <option value="medium">–°—Ä–µ–¥–Ω—è—è</option>
                                        <option value="hard">–°–ª–æ–∂–Ω–∞—è</option>
                                    </select>
                                    <input type="number" id="gen-count" class="input-field" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" value="10">
                                    <button onclick="sgeneritovatZadachi()" class="btn-primary w-full">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card p-6 mt-6">
                            <h3 class="text-xl font-bold mb-4">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                            <div id="admin-users-list" class="overflow-auto max-h-96">
                            </div>
                        </div>
                    </section>
                </main>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // EduBattle Client v3.0
        // —Å —Ç—É—Ä–Ω–∏—Ä–∞–º–∏ –∏ –º–∞—Ä–∞—Ñ–æ–Ω–∞–º–∏
        // ============================================

        // –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        let tekushiyUser = null;
        let tekushiyMatch = null;
        let tekushiyEvent = null;
        let treningZadachi = [];
        let treningIndex = 0;
        let treningPravilno = 0;
        let treningTimer = null;
        let treningSekundy = 0;
        let zadachaStartTime = 0;

        // websocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        let wsConnection = null;
        let wsReconnectTimer = null;
        let wsPingInterval = null;
        let pvpTimerInterval = null;
        let pvpSekundy = 30;
        let poiskInterval = null;
        let posledniyMatchId = null;

        // —Å–æ–±—ã—Ç–∏—è
        let vseEventy = [];
        let moiEventy = [];
        let eventCountdownInterval = null;
        let currentEventFilter = 'all';

        const API_URL = window.location.origin;

        // ============================================
        // –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª
        // ============================================
        let moySeed = Date.now();

        function moyRandom() {
            let a = 1103515245;
            let c = 12345;
            let m = 2147483648;
            moySeed = (a * moySeed + c) % m;
            let dop = Date.now() % 1000;
            moySeed = (moySeed + dop) % m;
            return moySeed / m;
        }

        function moyRandomInt(min, max) {
            let r = moyRandom();
            let razmer = max - min + 1;
            return Math.floor(r * razmer) + min;
        }

        // ============================================
        // –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        // ============================================

        function moyIndexOf(massiv, znachenie, pole) {
            let i = 0;
            while (i < massiv.length) {
                if (pole != undefined) {
                    if (massiv[i][pole] === znachenie) {
                        return i;
                    }
                } else {
                    if (massiv[i] === znachenie) {
                        return i;
                    }
                }
                i = i + 1;
            }
            return -1;
        }

        function formatirovatVremya(sekundy) {
            let min = Math.floor(sekundy / 60);
            let sek = sekundy % 60;
            let strMin = min < 10 ? '0' + min : '' + min;
            let strSek = sek < 10 ? '0' + sek : '' + sek;
            return strMin + ':' + strSek;
        }

        function formatirovatDatu(dateStr) {
            if (!dateStr) return '-';
            let d = new Date(dateStr);
            let den = d.getDate();
            let mesyac = d.getMonth() + 1;
            let god = d.getFullYear();
            let chas = d.getHours();
            let min = d.getMinutes();
            return `${den < 10 ? '0' + den : den}.${mesyac < 10 ? '0' + mesyac : mesyac}.${god} ${chas < 10 ? '0' + chas : chas}:${min < 10 ? '0' + min : min}`;
        }

        function poluchitNazvaniePredmeta(key) {
            let predmety = {
                'math': '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞',
                'physics': '–§–∏–∑–∏–∫–∞',
                'russian': '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫',
                'history': '–ò—Å—Ç–æ—Ä–∏—è',
                'informatics': '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞',
                'all': '–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã'
            };
            return predmety[key] || key;
        }

        // ============================================
        // —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API
        // ============================================

        async function apiZapros(endpoint, options) {
            if (options == undefined) {
                options = {};
            }

            let url = API_URL + endpoint;

            let nastroyki = {
                headers: {
                    'Content-Type': 'application/json'
                }
            };

            if (options.method != undefined) {
                nastroyki.method = options.method;
            }
            if (options.body != undefined) {
                nastroyki.body = JSON.stringify(options.body);
            }

            try {
                let response = await fetch(url, nastroyki);
                let data = await response.json();

                if (response.ok == false) {
                    let msg = data.detail || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞';
                    throw new Error(msg);
                }

                return data;
            } catch (err) {
                console.log('API –æ—à–∏–±–∫–∞:', err);
                throw err;
            }
        }

        // ============================================
        // WebSocket —Ñ—É–Ω–∫—Ü–∏–∏
        // ============================================

        function podkluchitWebSocket(matchId) {
            if (wsConnection != null) {
                wsConnection.close();
            }

            obnovitWsStatus('connecting');

            let wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            let wsUrl = wsProtocol + '//' + window.location.host + '/ws/match/' + matchId + '/' + tekushiyUser.id;

            console.log('–ø–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ –≤–µ–±—Å–æ–∫–µ—Ç—É:', wsUrl);

            wsConnection = new WebSocket(wsUrl);

            wsConnection.onopen = function() {
                console.log('–≤–µ–±—Å–æ–∫–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω');
                obnovitWsStatus('connected');

                wsConnection.send(JSON.stringify({
                    type: 'get_state'
                }));

                if (wsPingInterval != null) {
                    clearInterval(wsPingInterval);
                    wsPingInterval = null;
                }
            };

            wsConnection.onmessage = function(event) {
                let data = JSON.parse(event.data);
                obrabotkaWsSoobsheniya(data);
            };

            wsConnection.onclose = function() {
                console.log('–≤–µ–±—Å–æ–∫–µ—Ç –æ—Ç–∫–ª—é—á–∏–ª—Å—è');
                obnovitWsStatus('disconnected');

                if (wsPingInterval != null) {
                    clearInterval(wsPingInterval);
                    wsPingInterval = null;
                }

                if (tekushiyMatch != null && tekushiyMatch.status === 'active') {
                    wsReconnectTimer = setTimeout(function() {
                        podkluchitWebSocket(matchId);
                    }, 3000);
                }
            };

            wsConnection.onerror = function(err) {
                console.log('–≤–µ–±—Å–æ–∫–µ—Ç –æ—à–∏–±–∫–∞:', err);
                obnovitWsStatus('disconnected');
            };
        }

        function obnovitWsStatus(status) {
            let indicator = document.getElementById('ws-indicator');
            let text = document.getElementById('ws-status-text');

            indicator.className = 'ws-status';

            if (status === 'connected') {
                indicator.classList.add('ws-connected');
                text.textContent = '–æ–Ω–ª–∞–π–Ω';
            } else if (status === 'connecting') {
                indicator.classList.add('ws-connecting');
                text.textContent = '–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
            } else {
                indicator.classList.add('ws-disconnected');
                text.textContent = '–æ—Ñ–ª–∞–π–Ω';
            }
        }

        function obrabotkaWsSoobsheniya(data) {
            console.log('ws —Å–æ–æ–±—â–µ–Ω–∏–µ:', data);

            let tip = data.type;

            if (tip === 'server_ping') {
                otpravitCherezWs({
                    type: 'pong',
                    timestamp: Date.now()
                });
                return;
            }

            if (tip === 'match_cancelled') {
                console.log('–ú–∞—Ç—á –æ—Ç–º–µ–Ω–µ–Ω —Å–µ—Ä–≤–µ—Ä–æ–º:', data.message);
                alert(data.message || "–ú–∞—Ç—á –æ—Ç–º–µ–Ω–µ–Ω –∏–∑-–∑–∞ –ø–æ—Ç–µ—Ä–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
                resetPvP();
                document.getElementById('pvp-setup').classList.remove('hidden');
                document.getElementById('pvp-match').classList.add('hidden');
                document.getElementById('pvp-searching').classList.add('hidden');
                document.getElementById('pvp-result').classList.add('hidden');
                return;
            }

            if (tip === 'pong') {
                // ok
            } else if (tip === 'state') {
                if (data.data != null) {
                    obnovitMatchIzWs(data.data);
                }
            } else if (tip === 'answer_result') {
                let el1 = document.getElementById('pvp-my-score');
                let el2 = document.getElementById('pvp-opp-score');

                if (tekushiyMatch != null) {
                    if (tekushiyMatch.am_player1 == true) {
                        el1.textContent = data.player1_score;
                        el2.textContent = data.player2_score;
                    } else {
                        el1.textContent = data.player2_score;
                        el2.textContent = data.player1_score;
                    }
                    tekushiyMatch.player1_score = data.player1_score;
                    tekushiyMatch.player2_score = data.player2_score;
                }
            } else if (tip === 'opponent_disconnected') {
                console.log('–°–æ–ø–µ—Ä–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è');
            } else if (tip === 'user_connected') {
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è:', data.user_id);
            }
        }

        function obnovitMatchIzWs(state) {
            if (tekushiyMatch == null) return;

            tekushiyMatch.my_score = state.my_score;
            tekushiyMatch.opp_score = state.opp_score;
            tekushiyMatch.am_player1 = state.am_player1;

            document.getElementById('pvp-my-score').textContent = state.my_score;
            document.getElementById('pvp-opp-score').textContent = state.opp_score;
        }

        function otpravitCherezWs(soobshenie) {
            if (wsConnection != null && wsConnection.readyState === WebSocket.OPEN) {
                wsConnection.send(JSON.stringify(soobshenie));
                return true;
            }
            return false;
        }

        // ============================================
        // –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        // ============================================

        function pokazatRegistraciyu() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
            document.getElementById('auth-error').classList.add('hidden');
        }

        function pokazatVhod() {
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('auth-error').classList.add('hidden');
        }

        function pokazatOshibkuAuth(tekst) {
            let el = document.getElementById('auth-error');
            el.textContent = tekst;
            el.classList.remove('hidden');
        }

        async function vypolnitVhod() {
            let email = document.getElementById('login-email').value;
            let password = document.getElementById('login-password').value;

            if (email === '' || password === '') {
                pokazatOshibkuAuth('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            try {
                let result = await apiZapros('/api/login', {
                    method: 'POST',
                    body: { email: email, password: password }
                });

                if (result.success == true) {
                    tekushiyUser = result.user;
                    localStorage.setItem('edubattle_user', JSON.stringify(tekushiyUser));
                    pokazatGlavniy();
                }
            } catch (err) {
                pokazatOshibkuAuth(err.message);
            }
        }

        async function vypolnitRegistraciyu() {
            let name = document.getElementById('reg-name').value;
            let email = document.getElementById('reg-email').value;
            let password = document.getElementById('reg-password').value;

            if (name === '' || email === '' || password === '') {
                pokazatOshibkuAuth('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            if (password.length < 6) {
                pokazatOshibkuAuth('–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }

            try {
                let result = await apiZapros('/api/register', {
                    method: 'POST',
                    body: { name: name, email: email, password: password }
                });

                if (result.success == true) {
                    tekushiyUser = result.user;
                    localStorage.setItem('edubattle_user', JSON.stringify(tekushiyUser));
                    pokazatGlavniy();
                }
            } catch (err) {
                pokazatOshibkuAuth(err.message);
            }
        }

        function vyjtiIzAkkunta() {
            tekushiyUser = null;
            localStorage.removeItem('edubattle_user');

            if (wsConnection != null) {
                wsConnection.close();
                wsConnection = null;
            }

            if (wsPingInterval != null) {
                clearInterval(wsPingInterval);
                wsPingInterval = null;
            }

            document.getElementById('main-screen').classList.add('hidden');
            document.getElementById('auth-screen').classList.remove('hidden');
        }

        // ============================================
        // –Ω–∞–≤–∏–≥–∞—Ü–∏—è
        // ============================================

        function pokazatSekciyu(name) {
            let vse = document.querySelectorAll('[id^="section-"]');
            let i = 0;
            while (i < vse.length) {
                vse[i].classList.add('hidden');
                i = i + 1;
            }

            let navItems = document.querySelectorAll('.nav-item');
            let j = 0;
            while (j < navItems.length) {
                navItems[j].classList.remove('active');
                j = j + 1;
            }

            let sekcia = document.getElementById('section-' + name);
            if (sekcia != null) {
                sekcia.classList.remove('hidden');
            }

            let navItem = document.querySelector('[data-section="' + name + '"]');
            if (navItem != null) {
                navItem.classList.add('active');
            }

            if (name === 'leaderboard') {
                zagruzitLiderboard();
            } else if (name === 'dashboard') {
                obnovitDashboard();
            } else if (name === 'admin') {
                zagruzitAdminData();
            } else if (name === 'results') {
                zagruzitIstoiyuMatchey();
            } else if (name === 'events') {
                zagruzitEventy();
            }
        }

        // ============================================
        // –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
        // ============================================

        async function pokazatGlavniy() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-screen').classList.remove('hidden');

            obnovitUserInfo();
            obnovitDashboard();

            if (tekushiyUser.isAdmin == true) {
                document.getElementById('admin-nav').classList.remove('hidden');
                document.getElementById('admin-event-btn').classList.remove('hidden');
            }
        }

        function obnovitUserInfo() {
            let imya = tekushiyUser.name;
            let pervayaBukva = imya.charAt(0).toUpperCase();

            document.getElementById('user-avatar').textContent = pervayaBukva;
            document.getElementById('user-name-sidebar').textContent = imya;
            document.getElementById('user-level-sidebar').textContent = tekushiyUser.level;
            document.getElementById('welcome-name').textContent = imya;

            document.getElementById('profile-avatar').textContent = pervayaBukva;
            document.getElementById('profile-name').textContent = imya;
            document.getElementById('profile-email').textContent = tekushiyUser.email;
            document.getElementById('profile-level').textContent = tekushiyUser.level;
            document.getElementById('profile-xp').textContent = tekushiyUser.xp;
            document.getElementById('profile-rating').textContent = tekushiyUser.rating;

            let xpDlyaLvla = tekushiyUser.level * 100;
            let ostatok = tekushiyUser.xp % xpDlyaLvla;
            let procent = (ostatok / xpDlyaLvla) * 100;
            document.getElementById('profile-xp-bar').style.width = procent + '%';

            let wins = tekushiyUser.stats.wins || 0;
            let losses = tekushiyUser.stats.losses || 0;
            let vsego = wins + losses;
            let winrate = vsego > 0 ? Math.round(wins / vsego * 100) : 0;
            document.getElementById('profile-winrate').textContent = winrate + '%';
        }

        async function obnovitDashboard() {
            let stats = tekushiyUser.stats || {};

            let solved = stats.solved || 0;
            let correct = stats.correct || 0;
            let wins = stats.wins || 0;

            document.getElementById('stat-solved').textContent = solved;
            document.getElementById('stat-wins').textContent = wins;
            document.getElementById('stat-rating').textContent = tekushiyUser.rating;

            let tochnost = solved > 0 ? Math.round(correct / solved * 100) : 0;
            document.getElementById('stat-correct').textContent = tochnost + '%';

            pokazatDostizheniya();
            pokazatIstoriyu();
            await zagruzitGrafikPoDnyam();
            pokazatStatistikuPredmetov();
            await zagruzitDashboardEventy();
        }

        async function zagruzitDashboardEventy() {
            let konteyner = document.getElementById('dashboard-events-list');

            try {
                let data = await apiZapros('/api/events?status=active');
                let events = data.events || [];

                if (events.length === 0) {
                    konteyner.innerHTML = '<p class="text-gray-400 col-span-2 text-center py-4">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π</p>';
                    return;
                }

                let html = '';
                let pokazano = 0;
                let i = 0;

                while (i < events.length && pokazano < 4) {
                    let e = events[i];
                    html += sozdatMiniKartochkuEventa(e);
                    pokazano++;
                    i++;
                }

                konteyner.innerHTML = html;

            } catch (err) {
                console.log('–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞:', err);
                konteyner.innerHTML = '<p class="text-gray-400 col-span-2 text-center py-4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
            }
        }

        function sozdatMiniKartochkuEventa(event) {
            let typeClass = event.type === 'marathon' ? 'marathon' : 'tournament';
            let typeIcon = event.type === 'marathon' ? 'üèÉ' : 'üèÜ';
            let typeName = event.type === 'marathon' ? '–ú–∞—Ä–∞—Ñ–æ–Ω' : '–¢—É—Ä–Ω–∏—Ä';

            return `
                <div class="event-card ${typeClass}" onclick="otkrytEvent(${event.id})" style="padding: 16px;">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="event-badge ${typeClass}" style="padding: 4px 8px; font-size: 10px;">
                            ${typeIcon} ${typeName}
                        </span>
                    </div>
                    <h4 class="font-bold truncate">${event.name}</h4>
                    <p class="text-sm text-gray-400 mt-1">${event.current_participants} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
                </div>
            `;
        }

        function pokazatDostizheniya() {
            let konteyner = document.getElementById('achievements-list');
            let achi = tekushiyUser.achievements || [];

            let achievementData = {
                'first_task': { icon: 'üéØ', name: '–ü–µ—Ä–≤—ã–π —à–∞–≥' },
                'ten_tasks': { icon: 'üìö', name: '–ù–∞—á–∏–Ω–∞—é—â–∏–π' },
                'fifty_tasks': { icon: 'üî•', name: '–£–ø–æ—Ä–Ω—ã–π' },
                'first_win': { icon: 'üèÜ', name: '–ü–æ–±–µ–¥–∏—Ç–µ–ª—å' },
                'ten_wins': { icon: '‚öîÔ∏è', name: '–ë–æ–µ—Ü' }
            };

            let html = '';

            for (let key in achievementData) {
                let data = achievementData[key];
                let polucheno = moyIndexOf(achi, key) !== -1;
                let opacity = polucheno ? '' : 'opacity-30';

                html += `<div class="text-center ${opacity}" title="${data.name}">
                    <div class="achievement-badge mx-auto mb-1">${data.icon}</div>
                    <div class="text-xs">${data.name}</div>
                </div>`;
            }

            konteyner.innerHTML = html;
        }

        function pokazatIstoriyu() {
            let konteyner = document.getElementById('activity-list');
            let istoriya = tekushiyUser.history || [];

            if (istoriya.length === 0) {
                konteyner.innerHTML = '<p class="text-gray-400 text-center">–ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>';
                return;
            }

            let html = '';
            let start = istoriya.length - 1;
            let count = 0;

            while (start >= 0 && count < 10) {
                let zapis = istoriya[start];
                html += `<div class="flex justify-between items-center p-2 bg-white/5 rounded">
                    <span>${zapis.text}</span>
                    <span class="text-gray-400 text-sm">${zapis.date}</span>
                </div>`;
                start--;
                count++;
            }

            konteyner.innerHTML = html;
        }

        async function zagruzitGrafikPoDnyam() {
            try {
                let data = await apiZapros('/api/user/' + tekushiyUser.id + '/daily_stats');

                let labels = [];
                let solvedData = [];
                let correctData = [];

                let i = 0;
                while (i < data.stats.length) {
                    labels.push(data.stats[i].day);
                    solvedData.push(data.stats[i].solved);
                    correctData.push(data.stats[i].correct);
                    i++;
                }

                sozdatGrafik(labels, solvedData, correctData);

            } catch (err) {
                console.log('–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', err);
                sozdatGrafik(['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'], [0,0,0,0,0,0,0], [0,0,0,0,0,0,0]);
            }
        }

        let weeklyChart = null;

        function sozdatGrafik(labels, solved, correct) {
            let ctx = document.getElementById('weekly-chart');

            if (weeklyChart != null) {
                weeklyChart.destroy();
            }

            weeklyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '–†–µ—à–µ–Ω–æ',
                            data: solved,
                            backgroundColor: 'rgba(102, 126, 234, 0.7)',
                            borderRadius: 6
                        },
                        {
                            label: '–ü—Ä–∞–≤–∏–ª—å–Ω–æ',
                            data: correct,
                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#e8e8e8' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y: {
                            ticks: { color: '#9ca3af' },
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function pokazatStatistikuPredmetov() {
            let konteyner = document.getElementById('subject-stats');
            let subjectStats = tekushiyUser.subjectStats || {};

            let predmety = {
                'math': '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞',
                'physics': '–§–∏–∑–∏–∫–∞',
                'russian': '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫',
                'history': '–ò—Å—Ç–æ—Ä–∏—è',
                'informatics': '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞'
            };

            let html = '';

            for (let key in predmety) {
                let stat = subjectStats[key] || { solved: 0, correct: 0 };
                let procent = stat.solved > 0 ? Math.round(stat.correct / stat.solved * 100) : 0;

                html += `<div class="flex justify-between items-center p-3 bg-white/5 rounded-lg">
                    <span>${predmety[key]}</span>
                    <div class="text-right">
                        <span class="text-gray-400 mr-3">${stat.solved} –∑–∞–¥–∞—á</span>
                        <span class="font-bold">${procent}%</span>
                    </div>
                </div>`;
            }

            konteyner.innerHTML = html;
        }

        // ============================================
        // –¢–£–†–ù–ò–†–´ –ò –ú–ê–†–ê–§–û–ù–´
        // ============================================

        async function zagruzitEventy() {
            await zagruzitMoiEventy();
            await zagruzitVseEventy();
        }

        async function zagruzitMoiEventy() {
            let konteyner = document.getElementById('my-active-events-list');

            try {
                let data = await apiZapros('/api/user/' + tekushiyUser.id + '/events');
                moiEventy = data.active_events || [];

                if (moiEventy.length === 0) {
                    konteyner.innerHTML = '<p class="text-gray-400 col-span-2 text-center py-4">–í—ã –ø–æ–∫–∞ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ —Å–æ–±—ã—Ç–∏—è—Ö</p>';
                    return;
                }

                let html = '';
                let i = 0;
                while (i < moiEventy.length) {
                    html += sozdatKartochkuEventa(moiEventy[i], true);
                    i++;
                }

                konteyner.innerHTML = html;

            } catch (err) {
                console.log('–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–∏—Ö —Å–æ–±—ã—Ç–∏–π:', err);
                konteyner.innerHTML = '<p class="text-gray-400 col-span-2 text-center py-4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
            }
        }

        async function zagruzitVseEventy() {
            let konteyner = document.getElementById('all-events-list');

            try {
                let data = await apiZapros('/api/events');
                vseEventy = data.events || [];

                if (vseEventy.length === 0) {
                    konteyner.innerHTML = '<p class="text-gray-400 col-span-3 text-center py-8">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π</p>';
                    return;
                }

                pokazatOtfiltrovanniyeEventy();

            } catch (err) {
                console.log('–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π:', err);
                konteyner.innerHTML = '<p class="text-gray-400 col-span-3 text-center py-8">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
            }
        }

        function filterEventy(filter, btn) {
            currentEventFilter = filter;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            let allBtns = document.querySelectorAll('.tabs-container .tab-btn');
            let i = 0;
            while (i < allBtns.length) {
                allBtns[i].classList.remove('active');
                i++;
            }
            btn.classList.add('active');

            pokazatOtfiltrovanniyeEventy();
        }

        function pokazatOtfiltrovanniyeEventy() {
            let konteyner = document.getElementById('all-events-list');
            let filtered = [];

            let i = 0;
            while (i < vseEventy.length) {
                let e = vseEventy[i];
                let podhodit = false;

                if (currentEventFilter === 'all') {
                    podhodit = true;
                } else if (currentEventFilter === 'active') {
                    podhodit = e.status === 'active';
                } else if (currentEventFilter === 'upcoming') {
                    podhodit = e.status === 'upcoming';
                } else if (currentEventFilter === 'marathon') {
                    podhodit = e.type === 'marathon';
                } else if (currentEventFilter === 'tournament') {
                    podhodit = e.type === 'tournament';
                } else if (currentEventFilter === 'my') {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—á–∞—Å—Ç–≤—É–µ–º –ª–∏ –º—ã
                    let j = 0;
                    while (j < moiEventy.length) {
                        if (moiEventy[j].id === e.id) {
                            podhodit = true;
                            break;
                        }
                        j++;
                    }
                }

                if (podhodit) {
                    filtered.push(e);
                }
                i++;
            }

            if (filtered.length === 0) {
                konteyner.innerHTML = '<p class="text-gray-400 col-span-3 text-center py-8">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É</p>';
                return;
            }

            let html = '';
            i = 0;
            while (i < filtered.length) {
                html += sozdatKartochkuEventa(filtered[i], false);
                i++;
            }

            konteyner.innerHTML = html;
        }

        function sozdatKartochkuEventa(event, isMy) {
            let typeClass = event.type === 'marathon' ? 'marathon' : 'tournament';
            let typeIcon = event.type === 'marathon' ? 'üèÉ' : 'üèÜ';
            let typeName = event.type === 'marathon' ? '–ú–∞—Ä–∞—Ñ–æ–Ω' : '–¢—É—Ä–Ω–∏—Ä';

            let statusClass = 'upcoming';
            let statusText = '–°–∫–æ—Ä–æ';
            if (event.status === 'active') {
                statusClass = 'active';
                statusText = '–ê–∫—Ç–∏–≤–µ–Ω';
            } else if (event.status === 'finished') {
                statusClass = 'finished';
                statusText = '–ó–∞–≤–µ—Ä—à—ë–Ω';
            }

            let description = event.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
            if (description.length > 100) {
                description = description.substring(0, 97) + '...';
            }

            let subjects = event.rules?.subjects || ['all'];
            let subjectsText = subjects.map(s => poluchitNazvaniePredmeta(s)).join(', ');

            let myBadge = isMy ? '<span class="absolute top-2 right-2 bg-purple-500 text-xs px-2 py-1 rounded-full">–£—á–∞—Å—Ç–≤—É—é</span>' : '';

            return `
                <div class="event-card ${typeClass}" onclick="otkrytEvent(${event.id})">
                    ${myBadge}
                    <div class="flex items-center justify-between mb-3">
                        <span class="event-badge ${typeClass}">
                            ${typeIcon} ${typeName}
                        </span>
                        <span class="event-status ${statusClass}">
                            <span class="w-2 h-2 rounded-full bg-current"></span>
                            ${statusText}
                        </span>
                    </div>

                    <h3 class="text-xl font-bold mb-2">${event.name}</h3>
                    <p class="text-gray-400 text-sm mb-4">${description}</p>

                    <div class="flex flex-wrap gap-2 mb-4">
                        <span class="text-xs bg-white/10 px-2 py-1 rounded">${subjectsText}</span>
                    </div>

                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-400">
                            üë• ${event.current_participants} / ${event.max_participants}
                        </span>
                        <span class="text-gray-400">
                            üìÖ ${formatirovatDatu(event.end_time)}
                        </span>
                    </div>
                </div>
            `;
        }

        async function otkrytEvent(eventId) {
            try {
                let event = await apiZapros('/api/events/' + eventId);
                tekushiyEvent = event;

                document.getElementById('events-list-view').classList.add('hidden');
                document.getElementById('event-detail-view').classList.remove('hidden');
                document.getElementById('event-create-form').classList.add('hidden');

                zapolnitDetalyEventa(event);
                zagruzitLiderbordEventa(eventId);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Ç–∞–±—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                if (event.type === 'marathon') {
                    document.getElementById('tab-activity').classList.remove('hidden');
                    document.getElementById('tab-matches').classList.add('hidden');
                    zagruzitAktivnostMarafona(eventId);
                } else {
                    document.getElementById('tab-activity').classList.add('hidden');
                    document.getElementById('tab-matches').classList.remove('hidden');
                    zagruzitMatchiTurnira(eventId);
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—á–∞—Å—Ç–∏–µ
                await proveritUchastie(eventId);

                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
                zapustitCountdown(event);

            } catch (err) {
                console.log('–æ—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–æ–±—ã—Ç–∏—è:', err);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏—è');
            }
        }

        function zapolnitDetalyEventa(event) {
            let typeClass = event.type === 'marathon' ? 'marathon' : 'tournament';
            let typeIcon = event.type === 'marathon' ? 'üèÉ' : 'üèÜ';
            let typeName = event.type === 'marathon' ? '–ú–∞—Ä–∞—Ñ–æ–Ω' : '–¢—É—Ä–Ω–∏—Ä';

            document.getElementById('event-detail-badge').className = 'event-badge ' + typeClass;
            document.getElementById('event-detail-badge').innerHTML = typeIcon + ' ' + typeName;

            let statusClass = event.status === 'active' ? 'active' : (event.status === 'upcoming' ? 'upcoming' : 'finished');
            let statusText = event.status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : (event.status === 'upcoming' ? '–°–∫–æ—Ä–æ' : '–ó–∞–≤–µ—Ä—à—ë–Ω');
            document.getElementById('event-detail-status').className = 'event-status ' + statusClass;
            document.getElementById('event-detail-status').textContent = statusText;

            document.getElementById('event-detail-name').textContent = event.name;
            document.getElementById('event-detail-description').textContent = event.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
            document.getElementById('event-detail-participants').textContent = event.current_participants;
            document.getElementById('event-detail-max').textContent = event.max_participants;

            // –ü—Ä–∞–≤–∏–ª–∞
            zapolnitPravila(event);

            // –ü—Ä–∏–∑—ã
            zapolnitPrizy(event);
        }

        function zapolnitPravila(event) {
            let konteyner = document.getElementById('event-rules-content');
            let rules = event.rules || {};

            let subjects = rules.subjects || ['all'];
            let subjectsText = subjects.map(s => poluchitNazvaniePredmeta(s)).join(', ');

            let html = '<ul class="rules-list">';

            html += `<li>
                <div class="rule-icon">üìö</div>
                <div>
                    <div class="font-medium">–ü—Ä–µ–¥–º–µ—Ç—ã</div>
                    <div class="text-gray-400 text-sm">${subjectsText}</div>
                </div>
            </li>`;

            if (rules.min_level) {
                html += `<li>
                    <div class="rule-icon">‚≠ê</div>
                    <div>
                        <div class="font-medium">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å</div>
                        <div class="text-gray-400 text-sm">${rules.min_level}</div>
                    </div>
                </li>`;
            }

            if (event.type === 'marathon' && rules.scoring) {
                let scoring = rules.scoring;
                html += `<li>
                    <div class="rule-icon">üéØ</div>
                    <div>
                        <div class="font-medium">–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –æ—á–∫–æ–≤</div>
                        <div class="text-gray-400 text-sm">
                            –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: ${scoring.training_task || 10} –æ—á–∫–æ–≤ –∑–∞ –∑–∞–¥–∞—á—É<br>
                            PvP –ø–æ–±–µ–¥–∞: ${scoring.pvp_win || 50} –æ—á–∫–æ–≤<br>
                            PvP –Ω–∏—á—å—è: ${scoring.pvp_draw || 20} –æ—á–∫–æ–≤<br>
                            PvP –ø–æ—Ä–∞–∂–µ–Ω–∏–µ: ${scoring.pvp_loss || 5} –æ—á–∫–æ–≤
                        </div>
                    </div>
                </li>`;
            }

            if (event.type === 'tournament') {
                html += `<li>
                    <div class="rule-icon">üèÜ</div>
                    <div>
                        <div class="font-medium">–†–∞—É–Ω–¥–æ–≤ –≤ —Ç—É—Ä–Ω–∏—Ä–µ</div>
                        <div class="text-gray-400 text-sm">${rules.rounds || 5}</div>
                    </div>
                </li>`;

                html += `<li>
                    <div class="rule-icon">‚ùì</div>
                    <div>
                        <div class="font-medium">–ó–∞–¥–∞–Ω–∏–π –≤ –º–∞—Ç—á–µ</div>
                        <div class="text-gray-400 text-sm">${rules.tasks_per_match || 5}</div>
                    </div>
                </li>`;
            }

            html += `<li>
                <div class="rule-icon">üìÖ</div>
                <div>
                    <div class="font-medium">–î–∞—Ç—ã –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è</div>
                    <div class="text-gray-400 text-sm">
                        ${formatirovatDatu(event.start_time)} ‚Äî ${formatirovatDatu(event.end_time)}
                    </div>
                </div>
            </li>`;

            html += '</ul>';
            konteyner.innerHTML = html;
        }

        function zapolnitPrizy(event) {
            let konteyner = document.getElementById('event-prizes-content');
            let prizes = event.prizes || {};

            let first = prizes.first || { xp: 500, title: '–ß–µ–º–ø–∏–æ–Ω' };
            let second = prizes.second || { xp: 300, title: '–°–µ—Ä–µ–±—Ä–æ' };
            let third = prizes.third || { xp: 150, title: '–ë—Ä–æ–Ω–∑–∞' };

            let html = `
                <div class="prize-card first">
                    <div class="prize-icon">ü•á</div>
                    <div class="text-2xl font-bold text-yellow-400">1 –º–µ—Å—Ç–æ</div>
                    <div class="text-gray-400 mt-2">${first.title}</div>
                    <div class="text-xl font-bold mt-2">+${first.xp} XP</div>
                </div>
                <div class="prize-card second">
                    <div class="prize-icon">ü•à</div>
                    <div class="text-2xl font-bold text-gray-300">2 –º–µ—Å—Ç–æ</div>
                    <div class="text-gray-400 mt-2">${second.title}</div>
                    <div class="text-xl font-bold mt-2">+${second.xp} XP</div>
                </div>
                <div class="prize-card third">
                    <div class="prize-icon">ü•â</div>
                    <div class="text-2xl font-bold text-amber-600">3 –º–µ—Å—Ç–æ</div>
                    <div class="text-gray-400 mt-2">${third.title}</div>
                    <div class="text-xl font-bold mt-2">+${third.xp} XP</div>
                </div>
            `;

            konteyner.innerHTML = html;
        }

        async function proveritUchastie(eventId) {
            try {
                let data = await apiZapros('/api/events/' + eventId + '/my_status?user_id=' + tekushiyUser.id);

                if (data.participating) {
                    document.getElementById('event-join-btn').textContent = '–ü–æ–∫–∏–Ω—É—Ç—å';
                    document.getElementById('event-join-btn').className = 'btn-danger';
                    document.getElementById('event-join-btn').onclick = function() { pokinutEvent(); };

                    document.getElementById('my-event-stats').classList.remove('hidden');
                    document.getElementById('my-event-rank').textContent = '#' + data.my_stats.rank;
                    document.getElementById('my-event-score').textContent = data.my_stats.score;
                    document.getElementById('my-event-tasks').textContent = data.my_stats.tasks_solved;
                    document.getElementById('my-event-matches').textContent = data.my_stats.matches_played;
                    document.getElementById('my-event-wins').textContent = data.my_stats.matches_won;
                } else {
                    document.getElementById('event-join-btn').textContent = '–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å';
                    document.getElementById('event-join-btn').className = 'btn-success';
                    document.getElementById('event-join-btn').onclick = function() { prisoedinitsyaKEventu(); };

                    document.getElementById('my-event-stats').classList.add('hidden');
                }

                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
                if (tekushiyEvent.status === 'finished') {
                    document.getElementById('event-join-btn').classList.add('hidden');
                } else {
                    document.getElementById('event-join-btn').classList.remove('hidden');
                }

            } catch (err) {
                console.log('–æ—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—á–∞—Å—Ç–∏—è:', err);
            }
        }

        async function prisoedinitsyaKEventu() {
            if (!tekushiyEvent) return;

            try {
                await apiZapros('/api/events/' + tekushiyEvent.id + '/join', {
                    method: 'POST',
                    body: { user_id: tekushiyUser.id }
                });

                alert('–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ —Å–æ–±—ã—Ç–∏—é!');
                await proveritUchastie(tekushiyEvent.id);
                await zagruzitLiderbordEventa(tekushiyEvent.id);

            } catch (err) {
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        async function pokinutEvent() {
            if (!tekushiyEvent) return;

            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å–æ–±—ã—Ç–∏–µ?')) return;

            try {
                await apiZapros('/api/events/' + tekushiyEvent.id + '/leave', {
                    method: 'POST',
                    body: { user_id: tekushiyUser.id }
                });

                alert('–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ —Å–æ–±—ã—Ç–∏–µ');
                await proveritUchastie(tekushiyEvent.id);
                await zagruzitLiderbordEventa(tekushiyEvent.id);

            } catch (err) {
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        function zapustitCountdown(event) {
            if (eventCountdownInterval) {
                clearInterval(eventCountdownInterval);
            }

            let targetDate;
            let labelText;

            if (event.status === 'upcoming') {
                targetDate = new Date(event.start_time);
                labelText = '–î–æ –Ω–∞—á–∞–ª–∞:';
            } else if (event.status === 'active') {
                targetDate = new Date(event.end_time);
                labelText = '–î–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è:';
            } else {
                document.getElementById('event-timer-section').classList.add('hidden');
                return;
            }

            document.getElementById('event-timer-section').classList.remove('hidden');
            document.getElementById('event-timer-label').textContent = labelText;

            function obnovitTimer() {
                let now = new Date();
                let diff = targetDate - now;

                if (diff <= 0) {
                    clearInterval(eventCountdownInterval);
                    document.getElementById('countdown-days').textContent = '00';
                    document.getElementById('countdown-hours').textContent = '00';
                    document.getElementById('countdown-minutes').textContent = '00';
                    document.getElementById('countdown-seconds').textContent = '00';
                    return;
                }

                let days = Math.floor(diff / (1000 * 60 * 60 * 24));
                let hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                let minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                let seconds = Math.floor((diff % (1000 * 60)) / 1000);

                document.getElementById('countdown-days').textContent = days < 10 ? '0' + days : days;
                document.getElementById('countdown-hours').textContent = hours < 10 ? '0' + hours : hours;
                document.getElementById('countdown-minutes').textContent = minutes < 10 ? '0' + minutes : minutes;
                document.getElementById('countdown-seconds').textContent = seconds < 10 ? '0' + seconds : seconds;
            }

            obnovitTimer();
            eventCountdownInterval = setInterval(obnovitTimer, 1000);
        }

        async function zagruzitLiderbordEventa(eventId) {
            let konteyner = document.getElementById('event-leaderboard-list');

            try {
                let data = await apiZapros('/api/events/' + eventId + '/leaderboard?limit=50');
                let leaderboard = data.leaderboard || [];

                if (leaderboard.length === 0) {
                    konteyner.innerHTML = '<p class="text-gray-400 text-center py-8">–ü–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>';
                    return;
                }

                let html = '';
                let i = 0;

                while (i < leaderboard.length) {
                    let p = leaderboard[i];
                    let rowClass = '';
                    let rankBadgeClass = 'default';
                    let rankContent = p.rank;

                    if (p.rank === 1) {
                        rowClass = 'top-1';
                        rankBadgeClass = 'gold';
                        rankContent = 'ü•á';
                    } else if (p.rank === 2) {
                        rowClass = 'top-2';
                        rankBadgeClass = 'silver';
                        rankContent = 'ü•à';
                    } else if (p.rank === 3) {
                        rowClass = 'top-3';
                        rankBadgeClass = 'bronze';
                        rankContent = 'ü•â';
                    }

                    if (p.user_id === tekushiyUser.id) {
                        rowClass += ' my-row';
                    }

                    html += `
                        <div class="leaderboard-row ${rowClass}">
                            <div class="rank-badge ${rankBadgeClass}">${rankContent}</div>
                            <div class="flex-1">
                                <div class="font-bold">${p.username}</div>
                                <div class="text-sm text-gray-400">
                                    –£—Ä. ${p.level} ‚Ä¢ –†–µ–π—Ç–∏–Ω–≥ ${p.rating}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-purple-400">${p.score}</div>
                                <div class="text-xs text-gray-400">–æ—á–∫–æ–≤</div>
                            </div>
                            <div class="text-right ml-6">
                                <div class="text-sm">${p.tasks_correct}/${p.tasks_solved}</div>
                                <div class="text-xs text-gray-400">–∑–∞–¥–∞—á</div>
                            </div>
                            <div class="text-right ml-6">
                                <div class="text-sm text-green-400">${p.matches_won}</div>
                                <div class="text-xs text-gray-400">–ø–æ–±–µ–¥</div>
                            </div>
                        </div>
                    `;
                    i++;
                }

                konteyner.innerHTML = html;

            } catch (err) {
                console.log('–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞:', err);
                konteyner.innerHTML = '<p class="text-gray-400 text-center py-8">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
            }
        }

        async function zagruzitAktivnostMarafona(eventId) {
            let konteyner = document.getElementById('event-activity-list');

            try {
                let data = await apiZapros('/api/events/' + eventId + '/marathon/activity?limit=50');
                let activity = data.activity || [];

                if (activity.length === 0) {
                    konteyner.innerHTML = '<p class="text-gray-400 text-center py-8">–ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>';
                    return;
                }

                let html = '';
                let i = 0;

                while (i < activity.length) {
                    let a = activity[i];
                    let icon = 'üìö';
                    let iconClass = 'training';
                    let actionText = '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞';

                    if (a.action_type === 'pvp_win') {
                        icon = 'üèÜ';
                        iconClass = 'pvp_win';
                        actionText = '–ü–æ–±–µ–¥–∞ –≤ PvP';
                    } else if (a.action_type === 'pvp_loss') {
                        icon = 'üòî';
                        iconClass = 'pvp_loss';
                        actionText = '–ü–æ—Ä–∞–∂–µ–Ω–∏–µ –≤ PvP';
                    } else if (a.action_type === 'pvp_draw') {
                        icon = 'ü§ù';
                        iconClass = 'pvp_draw';
                        actionText = '–ù–∏—á—å—è –≤ PvP';
                    }

                    let details = '';
                    if (a.details) {
                        if (a.details.subject) {
                            details = poluchitNazvaniePredmeta(a.details.subject);
                        }
                        if (a.details.opponent) {
                            details = 'vs ' + a.details.opponent;
                        }
                        if (a.details.score) {
                            details += ' (' + a.details.score + ')';
                        }
                    }

                    html += `
                        <div class="activity-item">
                            <div class="activity-icon ${iconClass}">${icon}</div>
                            <div class="flex-1">
                                <div class="font-medium">${a.username || '–£—á–∞—Å—Ç–Ω–∏–∫'}</div>
                                <div class="text-sm text-gray-400">${actionText} ${details}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-purple-400">+${a.points}</div>
                                <div class="text-xs text-gray-400">${formatirovatDatu(a.created_at)}</div>
                            </div>
                        </div>
                    `;
                    i++;
                }

                konteyner.innerHTML = html;

            } catch (err) {
                console.log('–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:', err);
                konteyner.innerHTML = '<p class="text-gray-400 text-center py-8">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
            }
        }

        async function zagruzitMatchiTurnira(eventId) {
            let konteyner = document.getElementById('tournament-matches-list');

            try {
                let data = await apiZapros('/api/events/' + eventId + '/tournament/matches');
                let matches = data.matches || [];

                document.getElementById('tournament-current-round').textContent = data.current_round || 0;
                document.getElementById('tournament-total-rounds').textContent = data.total_rounds || 5;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞—á–∞–ª–∞ —Ä–∞—É–Ω–¥–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞
                if (tekushiyUser.isAdmin && tekushiyEvent.status === 'active') {
                    document.getElementById('start-round-btn').classList.remove('hidden');
                } else {
                    document.getElementById('start-round-btn').classList.add('hidden');
                }

                if (matches.length === 0) {
                    konteyner.innerHTML = '<p class="text-gray-400 text-center py-8">–ú–∞—Ç—á–∏ —Ç—É—Ä–Ω–∏—Ä–∞ –µ—â—ë –Ω–µ –Ω–∞—á–∞–ª–∏—Å—å</p>';
                    return;
                }

                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Ä–∞—É–Ω–¥–∞–º
                let rounds = {};
                let i = 0;
                while (i < matches.length) {
                    let m = matches[i];
                    if (!rounds[m.round_num]) {
                        rounds[m.round_num] = [];
                    }
                    rounds[m.round_num].push(m);
                    i++;
                }

                let html = '';

                for (let roundNum in rounds) {
                    html += `<div class="mb-6">
                        <h4 class="text-lg font-bold mb-3">–†–∞—É–Ω–¥ ${roundNum}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;

                    let j = 0;
                    while (j < rounds[roundNum].length) {
                        let m = rounds[roundNum][j];
                        let isMyMatch = (m.player1_id === tekushiyUser.id || m.player2_id === tekushiyUser.id);
                        let matchClass = isMyMatch ? 'my-match' : '';
                        if (m.status === 'finished') matchClass += ' finished';

                        let p1Class = m.winner_id === m.player1_id ? 'winner' : (m.winner_id ? 'loser' : '');
                        let p2Class = m.winner_id === m.player2_id ? 'winner' : (m.winner_id ? 'loser' : '');

                        let actionBtn = '';
                        if (m.status === 'pending' && isMyMatch && tekushiyEvent.status === 'active') {
                            actionBtn = `<button onclick="nachatMatchTurnira(${eventId}, ${m.id})" class="btn-primary text-sm mt-2 w-full">–ù–∞—á–∞—Ç—å –º–∞—Ç—á</button>`;
                        } else if (m.status === 'active' && isMyMatch) {
                            actionBtn = `<button onclick="prodolzhitMatchTurnira(${m.match_id})" class="btn-success text-sm mt-2 w-full">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>`;
                        }

                        html += `
                            <div class="tournament-match ${matchClass}">
                                <div class="player-slot ${p1Class}">
                                    <span>${m.player1_name || 'TBD'}</span>
                                    ${m.winner_id === m.player1_id ? '<span class="text-green-400">üèÜ</span>' : ''}
                                </div>
                                <div class="text-center text-sm text-gray-400 my-1">VS</div>
                                <div class="player-slot ${p2Class}">
                                    <span>${m.player2_name || 'TBD'}</span>
                                    ${m.winner_id === m.player2_id ? '<span class="text-green-400">üèÜ</span>' : ''}
                                </div>
                                ${actionBtn}
                            </div>
                        `;
                        j++;
                    }

                    html += '</div></div>';
                }

                konteyner.innerHTML = html;

            } catch (err) {
                console.log('–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç—á–µ–π —Ç—É—Ä–Ω–∏—Ä–∞:', err);
                konteyner.innerHTML = '<p class="text-gray-400 text-center py-8">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
            }
        }

        async function nachatRaundTurnira() {
            if (!tekushiyEvent || !tekushiyUser.isAdmin) return;

            try {
                let result = await apiZapros('/api/events/' + tekushiyEvent.id + '/tournament/start_round?user_id=' + tekushiyUser.id, {
                    method: 'POST'
                });

                alert('–†–∞—É–Ω–¥ ' + result.round + ' –Ω–∞—á–∞—Ç! –°–æ–∑–¥–∞–Ω–æ –º–∞—Ç—á–µ–π: ' + result.matches.length);
                await zagruzitMatchiTurnira(tekushiyEvent.id);

            } catch (err) {
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        async function nachatMatchTurnira(eventId, tournamentMatchId) {
            try {
                let result = await apiZapros('/api/events/' + eventId + '/tournament/start_match/' + tournamentMatchId + '?user_id=' + tekushiyUser.id, {
                    method: 'POST'
                });

                if (result.success && result.match) {
                    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Å–µ–∫—Ü–∏—é PvP
                    pokazatSekciyu('pvp');
                    nachatMatch(result.match);
                }

            } catch (err) {
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        function prodolzhitMatchTurnira(matchId) {
            // –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∞–∫—Ç–∏–≤–Ω–æ–º—É –º–∞—Ç—á—É
            pokazatSekciyu('pvp');
            // TODO: –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –º–∞—Ç—á
        }

        function pokazatEventTab(tabName, btn) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ç–∞–±—ã
            document.getElementById('event-tab-leaderboard').classList.add('hidden');
            document.getElementById('event-tab-rules').classList.add('hidden');
            document.getElementById('event-tab-prizes').classList.add('hidden');
            document.getElementById('event-tab-activity').classList.add('hidden');
            document.getElementById('event-tab-matches').classList.add('hidden');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π
            document.getElementById('event-tab-' + tabName).classList.remove('hidden');

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
            let allBtns = btn.parentElement.querySelectorAll('.tab-btn');
            let i = 0;
            while (i < allBtns.length) {
                allBtns[i].classList.remove('active');
                i++;
            }
            btn.classList.add('active');
        }

        function vernutsyaKSpiskuEventov() {
            if (eventCountdownInterval) {
                clearInterval(eventCountdownInterval);
            }

            document.getElementById('events-list-view').classList.remove('hidden');
            document.getElementById('event-detail-view').classList.add('hidden');
            document.getElementById('event-create-form').classList.add('hidden');

            tekushiyEvent = null;
        }

        function pokazatFormuSozdaniyaEventa() {
            document.getElementById('events-list-view').classList.add('hidden');
            document.getElementById('event-detail-view').classList.add('hidden');
            document.getElementById('event-create-form').classList.remove('hidden');
        }

        function otmenitSozdanieEventa() {
            document.getElementById('events-list-view').classList.remove('hidden');
            document.getElementById('event-create-form').classList.add('hidden');
        }

        async function sozdatEvent() {
            let name = document.getElementById('event-create-name').value;
            let description = document.getElementById('event-create-description').value;
            let type = document.getElementById('event-create-type').value;
            let start = document.getElementById('event-create-start').value;
            let end = document.getElementById('event-create-end').value;
            let max = parseInt(document.getElementById('event-create-max').value) || 100;
            let subjectsStr = document.getElementById('event-create-subjects').value;

            if (!name || !start || !end) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
                return;
            }

            let subjects = subjectsStr.split(',').map(s => s.trim()).filter(s => s);
            if (subjects.length === 0) subjects = ['all'];

            let rules = {
                subjects: subjects,
                min_level: 1
            };

            if (type === 'marathon') {
                rules.scoring = {
                    training_task: 10,
                    pvp_win: 50,
                    pvp_draw: 20,
                    pvp_loss: 5
                };
            } else {
                rules.rounds = 5;
                rules.tasks_per_match = 5;
                rules.points = { win: 3, draw: 1, loss: 0 };
            }

            try {
                let result = await apiZapros('/api/events?user_id=' + tekushiyUser.id, {
                    method: 'POST',
                    body: {
                        name: name,
                        description: description,
                        type: type,
                        start_time: start,
                        end_time: end,
                        rules: rules,
                        max_participants: max,
                        prizes: {
                            first: { xp: 500, title: '–ß–µ–º–ø–∏–æ–Ω' },
                            second: { xp: 300, title: '–°–µ—Ä–µ–±—Ä–æ' },
                            third: { xp: 150, title: '–ë—Ä–æ–Ω–∑–∞' }
                        }
                    }
                });

                if (result.success) {
                    alert('–°–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ!');
                    otmenitSozdanieEventa();
                    await zagruzitEventy();
                }

            } catch (err) {
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        // ============================================
        // —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞
        // ============================================

        async function nachatTrenirovku() {
            let subject = document.getElementById('training-subject').value;
            let difficulty = document.getElementById('training-difficulty').value;
            let count = parseInt(document.getElementById('training-count').value);

            try {
                let result = await apiZapros('/api/training/start?subject=' + subject + '&difficulty=' + difficulty + '&count=' + count + '&user_id=' + tekushiyUser.id, {
                    method: 'POST'
                });

                treningZadachi = result.tasks;
                treningIndex = 0;
                treningPravilno = 0;
                treningSekundy = 0;

                document.getElementById('training-setup').classList.add('hidden');
                document.getElementById('training-active').classList.remove('hidden');
                document.getElementById('training-results').classList.add('hidden');

                document.getElementById('training-total').textContent = treningZadachi.length;

                pokazatZadachuTraining();
                zapustitTimer();

            } catch (err) {
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        function pokazatZadachuTraining() {
            let zadacha = treningZadachi[treningIndex];

            document.getElementById('training-current').textContent = treningIndex + 1;
            document.getElementById('training-topic').textContent = zadacha.topic || '–ó–∞–¥–∞—á–∞';
            document.getElementById('training-question').textContent = zadacha.question;
            document.getElementById('training-hint').classList.add('hidden');
            document.getElementById('training-hint-text').textContent = zadacha.hint || '';

            let progress = (treningIndex / treningZadachi.length) * 100;
            document.getElementById('training-progress').style.width = progress + '%';

            let konteyner = document.getElementById('training-options');
            let html = '';

            let i = 0;
            while (i < zadacha.options.length) {
                let opt = zadacha.options[i];
                let optEscaped = opt.replace(/'/g, "\\'");
                html += '<div class="task-option" onclick="vybratOtvetTraining(this, \'' + optEscaped + '\')">' + opt + '</div>';
                i++;
            }

            konteyner.innerHTML = html;
            document.getElementById('training-next-btn').disabled = true;

            zadachaStartTime = Date.now();
        }

        function vybratOtvetTraining(element, otvet) {
            let zadacha = treningZadachi[treningIndex];

            let vse = document.querySelectorAll('#training-options .task-option');
            let i = 0;
            while (i < vse.length) {
                vse[i].classList.remove('selected', 'correct', 'wrong');
                i++;
            }

            let pravilno = (otvet === zadacha.answer);

            if (pravilno) {
                element.classList.add('correct');
                treningPravilno++;
            } else {
                element.classList.add('wrong');
                let j = 0;
                while (j < vse.length) {
                    if (vse[j].textContent === zadacha.answer) {
                        vse[j].classList.add('correct');
                    }
                    j++;
                }
            }

            document.getElementById('training-next-btn').disabled = false;
        }

        function pokazatPodskazku() {
            document.getElementById('training-hint').classList.remove('hidden');
        }

        async function sleduushayaZadachaTraining() {
            treningIndex++;

            if (treningIndex >= treningZadachi.length) {
                await zavershitTrenirovku();
            } else {
                pokazatZadachuTraining();
            }
        }

        async function zavershitTrenirovku() {
            ostanovitTimer();

            let xpEarned = treningPravilno * 10 + Math.floor(treningSekundy / 10);
            let subject = document.getElementById('training-subject').value;

            try {
                let result = await apiZapros('/api/training/result', {
                    method: 'POST',
                    body: {
                        user_id: tekushiyUser.id,
                        tasks_solved: treningZadachi.length,
                        correct_count: treningPravilno,
                        xp_earned: xpEarned,
                        subject: subject
                    }
                });

                if (result.success) {
                    tekushiyUser = result.user;
                    localStorage.setItem('edubattle_user', JSON.stringify(tekushiyUser));
                    obnovitUserInfo();
                }

            } catch (err) {
                console.log('–æ—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', err);
            }

            document.getElementById('training-active').classList.add('hidden');
            document.getElementById('training-results').classList.remove('hidden');

            document.getElementById('result-correct').textContent = treningPravilno;
            document.getElementById('result-wrong').textContent = treningZadachi.length - treningPravilno;
            document.getElementById('result-xp').textContent = '+' + xpEarned;
        }

        function zapustitTimer() {
            treningTimer = setInterval(function() {
                treningSekundy++;
                document.getElementById('training-timer').textContent = formatirovatVremya(treningSekundy);
            }, 1000);
        }

        function ostanovitTimer() {
            if (treningTimer != null) {
                clearInterval(treningTimer);
                treningTimer = null;
            }
        }

        function resetTrenirovku() {
            document.getElementById('training-setup').classList.remove('hidden');
            document.getElementById('training-active').classList.add('hidden');
            document.getElementById('training-results').classList.add('hidden');

            treningZadachi = [];
            treningIndex = 0;
            treningPravilno = 0;
            treningSekundy = 0;
        }

        // ============================================
        // PvP –º–∞—Ç—á–∏
        // ============================================

        async function iskatSopernika() {
            let subject = document.getElementById('pvp-subject').value;
            let mode = document.getElementById('pvp-mode').value;

            try {
                let result = await apiZapros('/api/match/search', {
                    method: 'POST',
                    body: {
                        user_id: tekushiyUser.id,
                        subject: subject,
                        mode: mode
                    }
                });

                if (result.status === 'matched') {
                    nachatMatch(result.match);
                } else if (result.status === 'waiting') {
                    document.getElementById('pvp-setup').classList.add('hidden');
                    document.getElementById('pvp-searching').classList.remove('hidden');
                    document.getElementById('queue-position').textContent = result.position;

                    poiskInterval = setInterval(proveritOchered, 2000);
                } else if (result.status === 'in_match') {
                    let matchState = await apiZapros('/api/match/state/' + result.match_id + '?user_id=' + tekushiyUser.id);
                    nachatMatch(matchState);
                }

            } catch (err) {
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        async function proveritOchered() {
            try {
                let result = await apiZapros('/api/match/check_queue/' + tekushiyUser.id);

                if (result.status === 'matched') {
                    clearInterval(poiskInterval);
                    nachatMatch(result.match);
                } else if (result.status === 'waiting') {
                    document.getElementById('queue-position').textContent = result.position;
                } else if (result.status === 'not_in_queue') {
                    clearInterval(poiskInterval);
                    resetPvP();
                }
            } catch (err) {
                console.log('–æ—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—á–µ—Ä–µ–¥–∏:', err);
            }
        }

        async function otmenitPoisk() {
            if (poiskInterval != null) {
                clearInterval(poiskInterval);
            }

            try {
                await apiZapros('/api/match/cancel_search/' + tekushiyUser.id, { method: 'POST' });
            } catch (err) {
                console.log('–æ—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã:', err);
            }

            resetPvP();
        }

        async function igratSBotom() {
            if (poiskInterval != null) {
                clearInterval(poiskInterval);
            }

            let subject = document.getElementById('pvp-subject').value;
            let mode = document.getElementById('pvp-mode').value;

            try {
                let result = await apiZapros('/api/match/play_with_bot', {
                    method: 'POST',
                    body: {
                        user_id: tekushiyUser.id,
                        subject: subject,
                        mode: mode
                    }
                });

                if (result.success) {
                    nachatMatch(result.match);
                }
            } catch (err) {
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        let pvpIndex = 0;
        let pvpOtvetyMoi = [];

        function nachatMatch(match) {
            tekushiyMatch = match;
            pvpIndex = 0;
            pvpOtvetyMoi = [];
            posledniyMatchId = match.id;

            tekushiyMatch.am_player1 = (match.player1_id === tekushiyUser.id);

            document.getElementById('pvp-setup').classList.add('hidden');
            document.getElementById('pvp-searching').classList.add('hidden');
            document.getElementById('pvp-match').classList.remove('hidden');
            document.getElementById('pvp-result').classList.add('hidden');

            document.getElementById('pvp-my-name').textContent = tekushiyUser.name;

            let oppName = match.player2_name || match.opp_name;
            document.getElementById('pvp-opp-name').textContent = oppName;
            document.getElementById('pvp-my-score').textContent = '0';
            document.getElementById('pvp-opp-score').textContent = '0';

            podkluchitWebSocket(match.id);
            pokazatZadachuPvP();
        }

        function pokazatZadachuPvP() {
            let tasks = tekushiyMatch.tasks;

            if (pvpIndex >= tasks.length) {
                zavershitPvP();
                return;
            }

            let zadacha = tasks[pvpIndex];

            document.getElementById('pvp-task-num').textContent = pvpIndex + 1;
            document.getElementById('pvp-topic').textContent = zadacha.topic || '–ó–∞–¥–∞—á–∞';
            document.getElementById('pvp-question').textContent = zadacha.question;

            let konteyner = document.getElementById('pvp-options');
            let html = '';

            let i = 0;
            while (i < zadacha.options.length) {
                let opt = zadacha.options[i];
                let optEscaped = opt.replace(/'/g, "\\'");
                html += '<div class="task-option" onclick="vybratOtvetPvP(this, \'' + optEscaped + '\')">' + opt + '</div>';
                i++;
            }

            konteyner.innerHTML = html;
            document.getElementById('pvp-next-btn').disabled = true;

            pvpSekundy = 30;
            document.getElementById('pvp-timer').textContent = pvpSekundy;

            if (pvpTimerInterval != null) {
                clearInterval(pvpTimerInterval);
            }

            pvpTimerInterval = setInterval(function() {
                pvpSekundy--;
                document.getElementById('pvp-timer').textContent = pvpSekundy;

                if (pvpSekundy <= 0) {
                    clearInterval(pvpTimerInterval);
                    sleduushayaZadachaPvP();
                }
            }, 1000);

            zadachaStartTime = Date.now();
        }

        async function vybratOtvetPvP(element, otvet) {
            let zadacha = tekushiyMatch.tasks[pvpIndex];
            let timeSpent = (Date.now() - zadachaStartTime) / 1000;

            let vse = document.querySelectorAll('#pvp-options .task-option');
            let i = 0;
            while (i < vse.length) {
                vse[i].classList.remove('selected', 'correct', 'wrong');
                vse[i].onclick = null;
                i++;
            }

            let pravilno = (otvet === zadacha.answer);

            if (pravilno) {
                element.classList.add('correct');
            } else {
                element.classList.add('wrong');
                let j = 0;
                while (j < vse.length) {
                    if (vse[j].textContent === zadacha.answer) {
                        vse[j].classList.add('correct');
                    }
                    j++;
                }
            }

            pvpOtvetyMoi.push({
                task_index: pvpIndex,
                answer: otvet,
                correct: pravilno,
                time_spent: timeSpent
            });

            let wsOtpravleno = otpravitCherezWs({
                type: 'answer',
                task_index: pvpIndex,
                answer: otvet,
                time_spent: timeSpent
            });

            if (!wsOtpravleno) {
                try {
                    let result = await apiZapros('/api/match/answer', {
                        method: 'POST',
                        body: {
                            match_id: tekushiyMatch.id,
                            user_id: tekushiyUser.id,
                            task_index: pvpIndex,
                            answer: otvet,
                            time_spent: timeSpent
                        }
                    });

                    if (tekushiyMatch.am_player1) {
                        document.getElementById('pvp-my-score').textContent = result.player1_score;
                        document.getElementById('pvp-opp-score').textContent = result.player2_score;
                    } else {
                        document.getElementById('pvp-my-score').textContent = result.player2_score;
                        document.getElementById('pvp-opp-score').textContent = result.player1_score;
                    }

                } catch (err) {
                    console.log('–æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞:', err);
                }
            }

            document.getElementById('pvp-next-btn').disabled = false;
        }

        function sleduushayaZadachaPvP() {
            if (pvpTimerInterval != null) {
                clearInterval(pvpTimerInterval);
            }

            pvpIndex++;

            if (pvpIndex >= tekushiyMatch.tasks.length) {
                zavershitPvP();
            } else {
                pokazatZadachuPvP();
            }
        }

        async function zavershitPvP() {
            if (pvpTimerInterval != null) {
                clearInterval(pvpTimerInterval);
            }

            if (wsConnection != null) {
                wsConnection.close();
                wsConnection = null;
            }

            if (wsPingInterval != null) {
                clearInterval(wsPingInterval);
                wsPingInterval = null;
            }

            try {
                let state = await apiZapros('/api/match/state/' + tekushiyMatch.id + '?user_id=' + tekushiyUser.id);

                let myScore = state.my_score;
                let oppScore = state.opp_score;

                let result;
                if (myScore > oppScore) {
                    result = 'win';
                } else if (myScore < oppScore) {
                    result = 'loss';
                } else {
                    result = 'draw';
                }

                let endResult = await apiZapros('/api/match/end', {
                    method: 'POST',
                    body: {
                        match_id: tekushiyMatch.id,
                        user_id: tekushiyUser.id,
                        result: result
                    }
                });

                if (endResult.success) {
                    tekushiyUser = endResult.user;
                    localStorage.setItem('edubattle_user', JSON.stringify(tekushiyUser));
                    obnovitUserInfo();

                    posledniyMatchId = endResult.match_id;
                }

                document.getElementById('pvp-match').classList.add('hidden');
                document.getElementById('pvp-result').classList.remove('hidden');

                if (result === 'win') {
                    document.getElementById('pvp-result-emoji').textContent = 'üèÜ';
                    document.getElementById('pvp-result-title').textContent = '–ü–æ–±–µ–¥–∞!';
                } else if (result === 'loss') {
                    document.getElementById('pvp-result-emoji').textContent = 'üòî';
                    document.getElementById('pvp-result-title').textContent = '–ü–æ—Ä–∞–∂–µ–Ω–∏–µ';
                } else {
                    document.getElementById('pvp-result-emoji').textContent = 'ü§ù';
                    document.getElementById('pvp-result-title').textContent = '–ù–∏—á—å—è';
                }

                document.getElementById('pvp-result-score').textContent = myScore + ' : ' + oppScore;

                let ratingChange = endResult.rating_change || 0;
                let znak = ratingChange >= 0 ? '+' : '';
                document.getElementById('pvp-rating-change').textContent = '–†–µ–π—Ç–∏–Ω–≥: ' + znak + ratingChange;

            } catch (err) {
                console.log('–æ—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∞—Ç—á–∞:', err);
                resetPvP();
            }
        }

        function resetPvP() {
            if (pvpTimerInterval != null) {
                clearInterval(pvpTimerInterval);
            }
            if (poiskInterval != null) {
                clearInterval(poiskInterval);
            }

            if (wsConnection != null) {
                wsConnection.close();
                wsConnection = null;
            }

            if (wsPingInterval != null) {
                clearInterval(wsPingInterval);
                wsPingInterval = null;
            }

            tekushiyMatch = null;

            document.getElementById('pvp-setup').classList.remove('hidden');
            document.getElementById('pvp-searching').classList.add('hidden');
            document.getElementById('pvp-match').classList.add('hidden');
            document.getElementById('pvp-result').classList.add('hidden');
        }

        // ============================================
        // –ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –º–∞—Ç—á–µ–π
        // ============================================

        async function zagruzitIstoiyuMatchey() {
            let konteyner = document.getElementById('matches-history-list');

            try {
                let data = await apiZapros('/api/user/' + tekushiyUser.id + '/match_history_detailed?limit=20');

                if (data.matches.length === 0) {
                    konteyner.innerHTML = '<p class="text-gray-400 text-center py-8">–ü–æ–∫–∞ –Ω–µ—Ç —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –º–∞—Ç—á–µ–π</p>';
                    return;
                }

                let html = '';

                let i = 0;
                while (i < data.matches.length) {
                    let match = data.matches[i];

                    let resultClass = '';
                    let resultIcon = '';

                    if (match.result === 'win') {
                        resultClass = 'border-l-4 border-green-500';
                        resultIcon = 'üèÜ';
                    } else if (match.result === 'loss') {
                        resultClass = 'border-l-4 border-red-500';
                        resultIcon = 'üòî';
                    } else {
                        resultClass = 'border-l-4 border-yellow-500';
                        resultIcon = 'ü§ù';
                    }

                    let predmetNazv = poluchitNazvaniePredmeta(match.subject);
                    let botMarka = match.is_bot ? ' ü§ñ' : '';

                    html += `<div class="match-result-card ${resultClass}" onclick="pokazatDetaliMatcha(${match.match_id})">
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="text-xl mr-2">${resultIcon}</span>
                                <span class="font-bold">vs ${match.opponent}${botMarka}</span>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold">${match.my_score} : ${match.opp_score}</div>
                                <div class="text-sm text-gray-400">${predmetNazv}</div>
                            </div>
                        </div>
                    </div>`;

                    i++;
                }

                konteyner.innerHTML = html;

            } catch (err) {
                console.log('–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', err);
                konteyner.innerHTML = '<p class="text-red-400 text-center py-8">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
            }
        }

        async function pokazatDetaliMatcha(matchId) {
            try {
                let data = await apiZapros('/api/match/' + matchId + '/details?user_id=' + tekushiyUser.id);

                document.getElementById('results-list-view').classList.add('hidden');
                document.getElementById('results-detail-view').classList.remove('hidden');

                let summary = data.summary;
                let tasks = data.tasks;

                document.getElementById('detail-my-score').textContent = summary.my_score;
                document.getElementById('detail-opp-score').textContent = summary.opp_score;

                let oppNameDisplay = summary.opp_name;
                if (summary.is_bot) {
                    oppNameDisplay += ' ü§ñ';
                }
                document.getElementById('detail-opp-name').textContent = oppNameDisplay;

                if (summary.result === 'win') {
                    document.getElementById('detail-result-emoji').textContent = 'üèÜ';
                    document.getElementById('detail-result-text').textContent = '–ü–æ–±–µ–¥–∞';
                } else if (summary.result === 'loss') {
                    document.getElementById('detail-result-emoji').textContent = 'üòî';
                    document.getElementById('detail-result-text').textContent = '–ü–æ—Ä–∞–∂–µ–Ω–∏–µ';
                } else {
                    document.getElementById('detail-result-emoji').textContent = 'ü§ù';
                    document.getElementById('detail-result-text').textContent = '–ù–∏—á—å—è';
                }

                document.getElementById('detail-subject').textContent = poluchitNazvaniePredmeta(summary.subject);

                let modeText = summary.mode === 'ranked' ? '–†–µ–π—Ç–∏–Ω–≥–æ–≤—ã–π' : '–û–±—ã—á–Ω—ã–π';
                document.getElementById('detail-mode').textContent = modeText;
                document.getElementById('detail-avg-time').textContent = summary.my_avg_time + ' —Å–µ–∫';
                document.getElementById('detail-opp-rating').textContent = summary.opp_rating;

                let total = summary.my_score + summary.opp_score;
                let myPercent = total > 0 ? (summary.my_score / total) * 100 : 50;
                let oppPercent = total > 0 ? (summary.opp_score / total) * 100 : 50;
                document.getElementById('detail-comparison-my').style.width = myPercent + '%';
                document.getElementById('detail-comparison-opp').style.width = oppPercent + '%';

                let konteyner = document.getElementById('tasks-details-list');
                let html = '';

                let i = 0;
                while (i < tasks.length) {
                    let task = tasks[i];

                    let myResultClass = task.my_correct ? 'text-green-400' : 'text-red-400';
                    let myResultIcon = task.my_correct ? '‚úÖ' : '‚ùå';
                    let oppResultIcon = task.opp_correct ? '‚úÖ' : '‚ùå';

                    let taskTopic = task.topic || '–û–±—â–µ–µ';

                    let myAnswerDisplay = task.my_answer || '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞';

                    let oppResultText = task.opp_correct ? '–í–µ—Ä–Ω–æ' : '–ù–µ–≤–µ—Ä–Ω–æ';

                    html += `<div class="task-detail-row">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <div class="text-sm text-purple-400 mb-1">–ó–∞–¥–∞–Ω–∏–µ ${i + 1} ‚Ä¢ ${taskTopic}</div>
                                <div class="font-medium">${task.question}</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-3">
                            <div class="bg-white/5 p-3 rounded-lg">
                                <div class="text-sm text-gray-400 mb-1">–í–∞—à –æ—Ç–≤–µ—Ç ${myResultIcon}</div>
                                <div class="${myResultClass} font-medium">${myAnswerDisplay}</div>
                                <div class="text-xs text-gray-500 mt-1">–í—Ä–µ–º—è: ${task.my_time} —Å–µ–∫</div>
                            </div>
                            <div class="bg-white/5 p-3 rounded-lg">
                                <div class="text-sm text-gray-400 mb-1">–°–æ–ø–µ—Ä–Ω–∏–∫ ${oppResultIcon}</div>
                                <div class="font-medium">${oppResultText}</div>
                                <div class="text-xs text-gray-500 mt-1">–í—Ä–µ–º—è: ${task.opp_time} —Å–µ–∫</div>
                            </div>
                        </div>
                        <div class="mt-3 p-2 bg-green-500/10 border border-green-500/30 rounded">
                            <span class="text-green-400 text-sm">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</span>
                            <span class="font-medium">${task.correct_answer}</span>
                        </div>
                        ${task.hint ? '<div class="mt-2 text-sm text-gray-400">üí° ' + task.hint + '</div>' : ''}
                    </div>`;

                    i++;
                }

                konteyner.innerHTML = html;

            } catch (err) {
                console.log('–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π:', err);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –º–∞—Ç—á–∞');
            }
        }

        function vernutsyaKSpiskuMatchey() {
            document.getElementById('results-list-view').classList.remove('hidden');
            document.getElementById('results-detail-view').classList.add('hidden');
        }

        function pokazatDetaliBoya() {
            pokazatSekciyu('results');

            if (posledniyMatchId != null) {
                setTimeout(function() {
                    pokazatDetaliMatcha(posledniyMatchId);
                }, 300);
            }
        }

        // ============================================
        // —Ä–µ–π—Ç–∏–Ω–≥ –ª–∏–¥–µ—Ä–æ–≤
        // ============================================

        async function zagruzitLiderboard() {
            let konteyner = document.getElementById('leaderboard-list');

            try {
                let data = await apiZapros('/api/leaderboard?limit=20');

                let html = '';

                let i = 0;
                while (i < data.length) {
                    let user = data[i];
                    let rank = user.rank;

                    let medalya = '';
                    if (rank === 1) {
                        medalya = 'ü•á';
                    } else if (rank === 2) {
                        medalya = 'ü•à';
                    } else if (rank === 3) {
                        medalya = 'ü•â';
                    } else {
                        medalya = '#' + rank;
                    }

                    let moy = user.id === tekushiyUser.id ? 'bg-purple-500/20' : '';

                    html += `<div class="flex items-center p-3 rounded-lg ${moy} hover:bg-white/5">
                        <div class="w-12 text-center text-xl">${medalya}</div>
                        <div class="flex-1">
                            <div class="font-bold">${user.name}</div>
                            <div class="text-sm text-gray-400">–£—Ä–æ–≤–µ–Ω—å ${user.level} ‚Ä¢ ${user.wins} –ø–æ–±–µ–¥</div>
                        </div>
                        <div class="text-xl font-bold">${user.rating}</div>
                    </div>`;

                    i++;
                }

                konteyner.innerHTML = html;

            } catch (err) {
                konteyner.innerHTML = '<p class="text-red-400 text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
            }
        }

        // ============================================
        // –∞–¥–º–∏–Ω–∫–∞
        // ============================================

        async function zagruzitAdminData() {
            try {
                let users = await apiZapros('/api/admin/users');

                let konteyner = document.getElementById('admin-users-list');
                let html = '<table class="w-full">';
                html += '<tr class="text-left text-gray-400"><th class="p-2">ID</th><th class="p-2">–ò–º—è</th><th class="p-2">Email</th><th class="p-2">–£—Ä–æ–≤–µ–Ω—å</th><th class="p-2">–†–µ–π—Ç–∏–Ω–≥</th></tr>';

                let i = 0;
                while (i < users.length) {
                    let u = users[i];
                    let adminMark = u.isAdmin ? ' üëë' : '';
                    html += `<tr class="border-t border-white/10">
                        <td class="p-2">${u.id}</td>
                        <td class="p-2">${u.name}${adminMark}</td>
                        <td class="p-2">${u.email}</td>
                        <td class="p-2">${u.level}</td>
                        <td class="p-2">${u.rating}</td>
                    </tr>`;
                    i++;
                }

                html += '</table>';
                konteyner.innerHTML = html;

            } catch (err) {
                console.log('–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥–º–∏–Ω–∫–∏:', err);
            }
        }

        async function dobavitZadachu() {
            let optionsStr = document.getElementById('admin-options').value;
            let optionsArr = optionsStr.split(',');
            let chistyeOptions = [];

            let i = 0;
            while (i < optionsArr.length) {
                let opt = optionsArr[i].trim();
                if (opt !== '') {
                    chistyeOptions.push(opt);
                }
                i++;
            }

            try {
                let result = await apiZapros('/api/tasks', {
                    method: 'POST',
                    body: {
                        subject: document.getElementById('admin-subject').value,
                        difficulty: document.getElementById('admin-difficulty').value,
                        topic: document.getElementById('admin-topic').value,
                        question: document.getElementById('admin-question').value,
                        options: chistyeOptions,
                        answer: document.getElementById('admin-answer').value,
                        hint: document.getElementById('admin-hint').value
                    }
                });

                if (result.success) {
                    alert('–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                    document.getElementById('admin-topic').value = '';
                    document.getElementById('admin-question').value = '';
                    document.getElementById('admin-options').value = '';
                    document.getElementById('admin-answer').value = '';
                    document.getElementById('admin-hint').value = '';
                }
            } catch (err) {
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        async function sgeneritovatZadachi() {
            let subject = document.getElementById('gen-subject').value;
            let difficulty = document.getElementById('gen-difficulty').value;
            let count = document.getElementById('gen-count').value;

            try {
                let result = await apiZapros('/api/admin/generate?subject=' + subject + '&difficulty=' + difficulty + '&count=' + count, {
                    method: 'POST'
                });

                if (result.success) {
                    alert('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∑–∞–¥–∞—á: ' + result.generated);
                }
            } catch (err) {
                alert('–û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        // ============================================
        // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        // ============================================

        window.onload = function() {
            let saved = localStorage.getItem('edubattle_user');

            if (saved != null) {
                try {
                    tekushiyUser = JSON.parse(saved);

                    apiZapros('/api/user/' + tekushiyUser.id).then(function(userData) {
                        tekushiyUser = userData;
                        localStorage.setItem('edubattle_user', JSON.stringify(tekushiyUser));
                        pokazatGlavniy();
                    }).catch(function() {
                        pokazatGlavniy();
                    });

                } catch (e) {
                    localStorage.removeItem('edubattle_user');
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('auth-screen').classList.remove('hidden');
                }
            } else {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        };
    </script>
</body>
</html>
